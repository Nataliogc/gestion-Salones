<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Reservas Salas y Restaurante</title>
    <style>
        :root {
            --primary: #0b4a6f;
            --primary-light: #e3f2fd;
            --accent: #a58c5f;
            --danger: #c62828;
            --success: #2e7d32;
            --bg: #f5f5f7;
            --border: #e0e0e0;
            --text-main: #333;
            --text-muted: #757575;
            --card-bg: #ffffff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                sans-serif;
            background: radial-gradient(circle at top left, #f5f5f7 0, #e3f2fd 40%, #fff 100%);
            color: var(--text-main);
        }

        .landing {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .landing-card {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.12);
            padding: 32px 28px 26px;
            max-width: 720px;
            width: 100%;
            border: 1px solid rgba(11, 74, 111, 0.08);
            position: relative;
            overflow: hidden;
        }

        .landing-card::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(
                circle at top right,
                rgba(11, 74, 111, 0.07),
                transparent 60%
            );
            pointer-events: none;
        }

        .landing-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
        }

        .landing-logo {
            width: 56px;
            height: 56px;
            border-radius: 18px;
            background: linear-gradient(135deg, #0b4a6f, #a58c5f);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 22px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.18);
        }

        .landing-title {
            font-size: 22px;
            font-weight: 650;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            color: #1b3a4b;
        }

        .landing-subtitle {
            margin-top: 4px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .landing-hotels {
            display: flex;
            gap: 14px;
            margin-top: 22px;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }

        .hotel-card {
            position: relative;
            flex: 1 1 220px;
            padding: 16px 14px;
            border-radius: 18px;
            background: #ffffff;
            border: 1px solid rgba(11, 74, 111, 0.08);
            box-shadow: 0 10px 18px rgba(0, 0, 0, 0.04);
            cursor: pointer;
            transition: transform 0.16s ease, box-shadow 0.16s ease,
                border-color 0.16s ease;
            overflow: hidden;
        }

        .hotel-card::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(
                circle at top left,
                rgba(165, 140, 95, 0.09),
                transparent 60%
            );
            opacity: 0;
            transition: opacity 0.18s ease;
        }

        .hotel-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.1);
            border-color: rgba(11, 74, 111, 0.18);
        }

        .hotel-card:hover::before {
            opacity: 1;
        }

        .hotel-name {
            font-size: 15px;
            font-weight: 600;
            color: #263238;
        }

        .hotel-tagline {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .hotel-badge {
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 10px;
            border-radius: 999px;
            background: rgba(11, 74, 111, 0.06);
            font-size: 11px;
            color: #0b4a6f;
        }

        .hotel-badge span.icon {
            font-size: 13px;
        }

        .landing-footer-text {
            margin-top: 18px;
            font-size: 11px;
            color: #9e9e9e;
        }

        .landing-footer-text strong {
            color: #616161;
        }

        .corner-chip {
            position: absolute;
            top: 18px;
            right: 18px;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(11, 74, 111, 0.08);
            color: #0b4a6f;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .corner-chip span.dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #43a047;
        }

        .app-container {
            display: none;
            min-height: 100vh;
            padding: 10px;
        }

        .app-shell {
            max-width: 1280px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 18px 35px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid rgba(11, 74, 111, 0.12);
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: linear-gradient(120deg, #0b4a6f, #215b7d);
            color: #ffffff;
        }

        .app-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-header-left img {
            height: 36px;
            filter: drop-shadow(0 6px 10px rgba(0, 0, 0, 0.4));
        }

        .app-header-text h1 {
            font-size: 18px;
            margin: 0;
        }

        .app-header-text small {
            font-size: 11px;
            opacity: 0.85;
        }

        .app-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge-hotel {
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 11px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .btn-logout {
            border-radius: 999px;
            border: none;
            padding: 4px 10px;
            font-size: 11px;
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .app-body {
            display: grid;
            grid-template-columns: 260px 1fr;
        }

        @media (max-width: 960px) {
            .app-body {
                grid-template-columns: 1fr;
            }
        }

        .side-panel {
            border-right: 1px solid var(--border);
            padding: 12px 12px 16px;
            background: #fcfcfd;
        }

        .main-panel {
            padding: 12px 16px 16px;
            background: #f4f6fb;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #37474f;
        }

        .filter-group {
            margin-bottom: 10px;
        }

        .filter-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 3px;
        }

        .filter-input,
        .filter-select {
            width: 100%;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 12px;
        }

        .toggle-row {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .toggle-pill {
            flex: 1;
            padding: 6px 8px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .toggle-pill.active {
            background: #e3f2fd;
            border-color: #0b4a6f;
            color: #0b4a6f;
        }

        .tab-strip {
            display: flex;
            border-radius: 999px;
            background: #e3f2fd;
            padding: 3px;
            gap: 3px;
            margin-bottom: 8px;
        }

        .tab-btn {
            flex: 1;
            border-radius: 999px;
            border: none;
            background: transparent;
            font-size: 11px;
            padding: 5px 0;
            cursor: pointer;
        }

        .tab-btn.active {
            background: #ffffff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary,
        .btn-secondary,
        .btn-anular,
        .btn-ai {
            border-radius: 999px;
            border: none;
            font-size: 12px;
            padding: 6px 12px;
            cursor: pointer;
        }

        .btn-primary {
            background: #0b4a6f;
            color: #fff;
        }

        .btn-primary:hover {
            background: #083752;
        }

        .btn-secondary {
            background: #eceff1;
            color: #37474f;
        }

        .btn-secondary:hover {
            background: #dde3e8;
        }

        .btn-anular {
            background: #ffebee;
            color: #c62828;
        }

        .btn-ai {
            background: #f3e5f5;
            color: #6a1b9a;
        }

        .calendar-container,
        .budget-container {
            background: #fff;
            border-radius: 12px;
            padding: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .calendar-header-title {
            font-weight: 600;
            color: #37474f;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-icon {
            width: 24px;
            height: 24px;
            border-radius: 999px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-icon:hover {
            background: #eceff1;
        }

        .calendar {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 11px;
        }

        .calendar th,
        .calendar td {
            border: 1px solid var(--border);
            padding: 4px;
            vertical-align: top;
        }

        .calendar th {
            background: #fafafa;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 3;
        }

        .calendar td:first-child,
        .calendar th:first-child {
            position: sticky;
            left: 0;
            z-index: 4;
            background: #fff;
        }

        .cell-salon,
        .cell-restaurante {
            height: 64px;
            cursor: pointer;
        }

        .cell-salon:hover,
        .cell-restaurante:hover {
            background: #f3f7ff;
        }

        .evt-box {
            border-radius: 999px;
            padding: 2px 8px;
            margin-bottom: 2px;
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid rgba(11, 74, 111, 0.12);
        }

        .evt-full {
            background: #e3f2fd;
            color: #0d47a1;
        }

        .rest-zone {
            min-height: 32px;
            border-radius: 8px;
            padding: 2px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .mesa-card {
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 10px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mesa-manana {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .mesa-tarde {
            background: #ede7f6;
            color: #4527a0;
        }

        .budget-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .budget-table th,
        .budget-table td {
            border: 1px solid var(--border);
            padding: 6px 8px;
        }

        .budget-table th {
            background: #fafafa;
            text-align: left;
            font-weight: 600;
        }

        .budget-row {
            cursor: pointer;
        }

        .budget-row:hover {
            background: #f5f5f5;
        }

        .badge {
            border-radius: 999px;
            padding: 2px 6px;
            font-size: 10px;
            display: inline-block;
        }

        .st-activo {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .st-anulado {
            background: #ffebee;
            color: #c62828;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.35);
            z-index: 999;
        }

        .modal {
            background: #ffffff;
            border-radius: 16px;
            max-width: 720px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.45);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(120deg, #0b4a6f, #215b7d);
            color: #fff;
        }

        .modal-title {
            font-size: 14px;
            font-weight: 600;
        }

        .btn-close-x {
            border-radius: 999px;
            border: none;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.16);
            color: #fff;
        }

        .modal-body {
            padding: 10px 14px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 8px 14px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .form-group {
            flex: 1 1 120px;
            min-width: 120px;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 12px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 50px;
        }

        .services-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-top: 6px;
        }

        .services-table th,
        .services-table td {
            border: 1px solid var(--border);
            padding: 4px;
        }

        .services-table th {
            background: #fafafa;
            text-align: left;
        }

        .btn-add-row {
            margin-top: 4px;
            border-radius: 999px;
            border: 1px dashed var(--border);
            padding: 4px 10px;
            font-size: 11px;
            background: #f9fafb;
            cursor: pointer;
        }

        .total-bar {
            margin-top: 6px;
            text-align: right;
            font-size: 12px;
        }

        .total-bar strong {
            font-size: 13px;
        }

        .ai-content {
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            max-width: 520px;
            width: 100%;
        }

        #aiResponseModal {
            align-items: center;
            justify-content: center;
        }

        .btn-small {
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 4px 8px;
            font-size: 11px;
            background: #fafafa;
            cursor: pointer;
        }

        .btn-small:hover {
            background: #eceff1;
        }

        .badge-rest {
            font-size: 11px;
            border-radius: 999px;
            padding: 2px 8px;
            background: #e3f2fd;
            color: #0d47a1;
        }

        .debug-note {
            font-size: 10px;
            color: #aaa;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="landing" id="landingPage">
        <div class="landing-card">
            <div class="corner-chip">
                <span class="dot"></span> Beta interna
            </div>
            <div class="landing-header">
                <div class="landing-logo">HR</div>
                <div>
                    <div class="landing-title">
                        Reservas Salas y Restaurante
                    </div>
                    <div class="landing-subtitle">
                        Gesti√≥n unificada de presupuestos, salones y restaurante para
                        <strong>Sercotel Guadiana</strong> y
                        <strong>Cumbria Spa&Hotel</strong>.
                    </div>
                </div>
            </div>

            <div class="landing-hotels">
                <div class="hotel-card" onclick="initApp('Guadiana')">
                    <div class="hotel-name">Sercotel Guadiana</div>
                    <div class="hotel-tagline">
                        Salones, eventos sociales y comidas de empresa.
                    </div>
                    <div class="hotel-badge">
                        <span class="icon">üèõÔ∏è</span>
                        <span>Ciudad Real ¬∑ Centro</span>
                    </div>
                </div>
                <div class="hotel-card" onclick="initApp('Cumbria')">
                    <div class="hotel-name">Cumbria Spa&Hotel</div>
                    <div class="hotel-tagline">
                        Convenciones, grupos deportivos y grandes banquetes.
                    </div>
                    <div class="hotel-badge">
                        <span class="icon">üåÑ</span>
                        <span>Ciudad Real ¬∑ Zona Norte</span>
                    </div>
                </div>
            </div>

            <div class="landing-footer-text">
                Panel interno de trabajo. <strong>No compartir enlace</strong> con
                clientes ni agencias. Versi√≥n conectada a Firebase (colecci√≥n
                <code>master_data</code>).
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="app-shell">
            <header class="app-header">
                <div class="app-header-left">
                    <img
                        id="headerLogo"
                        src="Img/logo-guadiana.svg"
                        alt="Logo hotel"
                    />
                    <div class="app-header-text">
                        <h1>Reservas Salas y Restaurante</h1>
                        <small
                            >Planificaci√≥n integrada ¬∑
                            <span id="tituloHotelActual"></span></small
                        >
                    </div>
                </div>
                <div class="app-header-right">
                    <div class="badge-hotel">
                        <span id="labelHotel"></span>
                    </div>
                    <button class="btn-logout" onclick="volverLanding()">
                        ‚¨Ö Volver
                    </button>
                </div>
            </header>

            <div class="app-body">
                <aside class="side-panel">
                    <div class="section-title">M√≥dulo</div>
                    <div class="tab-strip">
                        <button
                            class="tab-btn active"
                            onclick="setModulo('eventos')"
                            id="btnModEventos"
                        >
                            üìÖ Salones
                        </button>
                        <button
                            class="tab-btn"
                            onclick="setModulo('restaurante')"
                            id="btnModRest"
                        >
                            üç¥ Restaurante
                        </button>
                        <button
                            class="tab-btn"
                            onclick="setModulo('presupuestos')"
                            id="btnModPpto"
                        >
                            üíº Presupuestos
                        </button>
                    </div>

                    <div class="filter-group">
                        <div class="filter-label">Fecha base (lunes de la semana)</div>
                        <input
                            type="date"
                            id="fechaVista"
                            class="filter-input"
                            onchange="updateTable()"
                        />
                    </div>

                    <div class="filter-group">
                        <div class="filter-label">Vista</div>
                        <div class="toggle-row">
                            <button
                                class="toggle-pill active"
                                id="btnVistaSemana"
                                onclick="setVista('semana')"
                            >
                                Semana
                            </button>
                            <button
                                class="toggle-pill"
                                id="btnVistaListado"
                                onclick="setVista('presupuestos')"
                            >
                                Listado Presupuestos
                            </button>
                        </div>
                    </div>

                    <div class="filter-group">
                        <div class="section-title">Acciones</div>
                        <button
                            class="btn-primary"
                            style="width: 100%; margin-bottom: 6px"
                            onclick="nuevoGeneral()"
                        >
                            + Nuevo registro
                        </button>
                        <div class="debug-note">
                            * Los registros se guardan en la colecci√≥n
                            <code>master_data</code> del proyecto Firebase configurado.
                        </div>
                    </div>

                    <div class="filter-group">
                        <div class="section-title">Notas r√°pidas</div>
                        <textarea
                            id="notasRapidas"
                            class="filter-input"
                            style="height: 80px; resize: vertical"
                            placeholder="Aqu√≠ puedes anotar detalles breves de √∫ltima hora..."
                        ></textarea>
                    </div>
                </aside>

                <main class="main-panel">
                    <div id="vistaCalendario" class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-header-title">
                                Planning semanal ¬∑
                                <span id="lblSemana"></span>
                            </div>
                            <div class="calendar-nav">
                                <button class="btn-icon" onclick="moverSemana(-1)">
                                    ‚óÄ
                                </button>
                                <button class="btn-icon" onclick="irSemanaActual()">
                                    Hoy
                                </button>
                                <button class="btn-icon" onclick="moverSemana(1)">
                                    ‚ñ∂
                                </button>
                            </div>
                        </div>
                        <table class="calendar">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>

                    <div
                        id="vistaPresupuestos"
                        class="budget-container"
                        style="display: none"
                    >
                        <div class="calendar-header">
                            <div class="calendar-header-title">
                                Listado de presupuestos
                            </div>
                        </div>
                        <table class="budget-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px">Fecha</th>
                                    <th>Cliente / Evento</th>
                                    <th>Sal√≥n</th>
                                    <th style="width: 90px">Ref</th>
                                    <th style="width: 90px">Estado</th>
                                    <th style="width: 100px; text-align: right">
                                        Importe
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="budgetBody"></tbody>
                        </table>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalFicha">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Nueva ficha</div>
                <button class="btn-close-x" onclick="cerrarModal()">√ó</button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="dataId" />
                <input type="hidden" id="dataType" />
                <input type="hidden" id="refPresupuesto" />
                <input type="hidden" id="fechaEmision" />

                <div
                    class="form-row"
                    style="
                        background: #f9f9f9;
                        padding: 10px;
                        margin-bottom: 8px;
                        border-radius: 8px;
                        border: 1px solid #e0e0e0;
                    "
                >
                    <div class="form-group">
                        <label>Cliente / Evento</label>
                        <input type="text" id="inpNombre" />
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="tel" id="inpTel" />
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="inpEmail" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" id="grpFechaUnica">
                        <label>Fecha</label>
                        <input type="date" id="inpFecha" />
                    </div>

                    <div
                        class="form-group"
                        id="grpRangoFechas"
                        style="display: none"
                    >
                        <div class="form-row" style="gap: 6px">
                            <div class="form-group">
                                <label>Desde</label>
                                <input type="date" id="inpFechaDesde" />
                            </div>
                            <div class="form-group">
                                <label>Hasta</label>
                                <input type="date" id="inpFechaHasta" />
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Espacio / Sal√≥n</label>
                        <select id="inpSalon"></select>
                    </div>

                    <div class="form-group" id="blockRestaurante">
                        <label>Hora</label>
                        <input type="time" id="inpHora" />
                    </div>
                    <div class="form-group">
                        <label>N¬∫ Pax</label>
                        <input type="number" id="inpPaxRest" />
                    </div>
                    <div class="form-group">
                        <label>Turno</label>
                        <select id="inpTurno">
                            <option value="manana">‚òÄÔ∏è Almuerzo</option>
                            <option value="tarde">üåô Cena</option>
                        </select>
                    </div>
                </div>

                <div id="blockEventos">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Montaje</label>
                            <select id="inpMontaje">
                                <option>Banquete</option>
                                <option>Escuela</option>
                                <option>Teatro</option>
                                <option>C√≥ctel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Turno sal√≥n</label>
                            <select id="inpTurnoSalon">
                                <option value="manana">Ma√±ana</option>
                                <option value="tarde">Tarde</option>
                                <option value="dia">Todo el d√≠a</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Pax Adultos</label>
                            <input type="number" id="inpPaxA" />
                        </div>
                        <div class="form-group">
                            <label>Pax Ni√±os</label>
                            <input type="number" id="inpPaxN" />
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 6px">
                        <label>Notas</label>
                        <textarea id="inpNotas"></textarea>
                    </div>

                    <div class="form-group" id="blockEconomico">
                        <label>Desglose econ√≥mico</label>
                        <table class="services-table">
                            <thead>
                                <tr>
                                    <th style="width: 90px">Fecha</th>
                                    <th>Descripci√≥n</th>
                                    <th style="width: 60px">Uds</th>
                                    <th style="width: 70px">Precio</th>
                                    <th style="width: 80px">Total</th>
                                    <th style="width: 26px"></th>
                                </tr>
                            </thead>
                            <tbody id="bodyServicios"></tbody>
                        </table>

                        <button
                            class="btn-add-row"
                            type="button"
                            onclick="addServiceRow()"
                        >
                            + A√±adir l√≠nea
                        </button>

                        <div class="total-bar">
                            Total presupuesto:
                            <strong><span id="totalAmount">0.00</span> ‚Ç¨</strong>
                        </div>
                    </div>
                </div>
            </div>

           <div class="modal-footer">
    <button
        class="btn-ai"
        id="btnEmailIA"
        onclick="redactarEmailIA()"
        type="button"
    >
        üìß Redactar Email Cliente
    </button>
    <button
        class="btn-secondary"
        id="btnPdf"
        onclick="imprimirPDF()"
        type="button"
    >
        üìÑ PDF Presupuesto
    </button>

    <div style="flex: 1"></div>

    <!-- NUEVO BOT√ìN CONFIRMAR (solo se ver√° en presupuestos) -->
    <button
        class="btn-primary"
        type="button"
        id="btnConfirmarPpto"
        onclick="confirmarPresupuesto()"
        style="display:none;"
    >
        Confirmar
    </button>

    <button class="btn-anular" type="button" onclick="anularFicha()">
        Anular
    </button>
    <button class="btn-primary" type="button" onclick="guardarFicha()">
        GUARDAR
    </button>
</div>

        </div>
    </div>

    <!-- MODAL IA -->
    <div class="modal-overlay" id="aiResponseModal">
        <div class="ai-content">
            <h3>ü§ñ Sugerencia IA</h3>
            <textarea
                id="aiOutput"
                style="width: 100%; height: 200px; margin: 10px 0; padding: 10px"
            ></textarea>
            <div
                style="
                    display: flex;
                    justify-content: space-between;
                    margin-top: 8px;
                "
            >
                <button class="btn-small" onclick="cerrarAiModal()">
                    Cerrar
                </button>
                <div style="display: flex; gap: 8px">
                    <button class="btn-small" onclick="aceptarTextoIA()">
                        Usar texto
                    </button>
                    <button class="btn-small" onclick="copiarTextoIA()">
                        Copiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE + APP -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Configuraci√≥n Firebase (ajusta con tu proyecto real)
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_DOMINIO.firebaseapp.com",
            projectId: "TU_PROJECT_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // API Key para Gemini (rellena si quieres usar la IA)
        const apiKey = "";

        let currentHotel = null;
        let currentModule = "eventos";
        let dataCache = [];

        const salones = {
            Guadiana: [
                "P. Alarcos",
                "P. Toledo",
                "P. Granada",
                "P. Carmen",
                "Restaurante",
                "Cafeter√≠a"
            ],
            Cumbria: [
                "Mercurio",
                "Venus",
                "Marte",
                "J√∫piter",
                "Saturno",
                "Restaurante",
                "Cafeter√≠a"
            ]
        };

        function initApp(hotel) {
            currentHotel = hotel;

            document.getElementById("landingPage").style.display = "none";
            document.getElementById("appContainer").style.display = "block";

            document.getElementById("tituloHotelActual").innerText = hotel;
            document.getElementById("headerLogo").src =
                hotel === "Guadiana"
                    ? "Img/logo-guadiana.svg"
                    : "Img/logo-cumbria.svg";

            document.getElementById("fechaVista").value =
                new Date().toISOString().split("T")[0];

            document.getElementById(
                "labelHotel"
            ).innerText = `Hotel actual: ${hotel}`;

            cargarDatos();
        }

        function volverLanding() {
            document.getElementById("appContainer").style.display = "none";
            document.getElementById("landingPage").style.display = "flex";
            currentHotel = null;
            dataCache = [];
        }

        function setModulo(m) {
            currentModule = m;

            document
                .querySelectorAll(".tab-btn")
                .forEach((b) => b.classList.remove("active"));

            const btnId =
                m === "eventos"
                    ? "btnModEventos"
                    : m === "restaurante"
                    ? "btnModRest"
                    : "btnModPpto";
            document.getElementById(btnId).classList.add("active");

            document.getElementById("vistaCalendario").style.display =
                m === "presupuestos" ? "none" : "block";
            document.getElementById("vistaPresupuestos").style.display =
                m === "presupuestos" ? "block" : "none";

            const isPresu = m === "presupuestos";
            document.getElementById("btnVistaSemana").disabled = isPresu;
            document.getElementById("btnVistaListado").disabled = !isPresu;

            const grpUnica = document.getElementById("grpFechaUnica");
            const grpRango = document.getElementById("grpRangoFechas");
            const blockEconomico = document.getElementById("blockEconomico");
            const blockRest = document.getElementById("blockRestaurante");
            const blockEventos = document.getElementById("blockEventos");
            const btnConfirm = document.getElementById("btnConfirmarPpto");
            const btnPdf = document.getElementById("btnPdf");

            if (m === "presupuestos") {
                grpUnica.style.display = "none";
                grpRango.style.display = "block";
                blockEconomico.style.display = "block";
                blockRest.style.display = "none";
                blockEventos.style.display = "block";
                btnConfirm.style.display = "inline-flex";
                btnPdf.style.display = "inline-flex";
            } else if (m === "restaurante") {
                grpUnica.style.display = "block";
                grpRango.style.display = "none";
                blockEconomico.style.display = "none";
                blockRest.style.display = "block";
                blockEventos.style.display = "none";
                btnConfirm.style.display = "none";
                btnPdf.style.display = "none";
            } else {
                grpUnica.style.display = "block";
                grpRango.style.display = "none";
                blockEconomico.style.display = "block";
                blockRest.style.display = "none";
                blockEventos.style.display = "block";
                btnConfirm.style.display = "none";
                btnPdf.style.display = "none";
            }

            updateTable();
        }

        function setVista(v) {
            if (v === "semana") {
                document.getElementById("vistaCalendario").style.display = "block";
                document.getElementById("vistaPresupuestos").style.display = "none";
                document
                    .getElementById("btnVistaSemana")
                    .classList.add("active");
                document
                    .getElementById("btnVistaListado")
                    .classList.remove("active");
                if (currentModule === "presupuestos") setModulo("eventos");
            } else {
                document.getElementById("vistaCalendario").style.display = "none";
                document.getElementById("vistaPresupuestos").style.display = "block";
                document
                    .getElementById("btnVistaSemana")
                    .classList.remove("active");
                document
                    .getElementById("btnVistaListado")
                    .classList.add("active");
                setModulo("presupuestos");
            }
        }

        function irSemanaActual() {
            const hoy = new Date();
            hoy.setDate(hoy.getDate() - hoy.getDay() + 1);
            document.getElementById("fechaVista").value =
                hoy.toISOString().split("T")[0];
            updateTable();
        }

        function moverSemana(delta) {
            const f = new Date(document.getElementById("fechaVista").value);
            f.setDate(f.getDate() + delta * 7);
            document.getElementById("fechaVista").value =
                f.toISOString().split("T")[0];
            updateTable();
        }

        function cargarDatos() {
            db.collection("master_data")
                .onSnapshot((snap) => {
                    dataCache = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
                    updateTable();
                });
        }

        function updateTable() {
            if (!currentHotel) return;

            const fVista = document.getElementById("fechaVista").value;
            const tipoBusca =
                currentModule === "restaurante" ? "restaurante" : "evento";

            // NUEVO: filtramos por hotel; el tipo se filtra m√°s abajo
            const filtered = dataCache.filter((x) => x.hotel === currentHotel);

            let headerHTML =
                '<tr><th style="width:200px; left:0; z-index:5;">ESPACIO</th>';
            for (let i = 0; i < 7; i++) {
                const d = new Date(fVista);
                d.setDate(d.getDate() + i);
                const dia = String(d.getDate()).padStart(2, "0");
                const mes = String(d.getMonth() + 1).padStart(2, "0");
                headerHTML += `<th>${dia}/${mes}</th>`;
            }
            headerHTML += "</tr>";
            const thead = document.getElementById("tableHead");
            const tbody = document.getElementById("tableBody");
            thead.innerHTML = "";
            tbody.innerHTML = "";
            thead.innerHTML = headerHTML;

            const spaces = salones[currentHotel].filter((s) => {
                if (currentModule === "restaurante")
                    return s.includes("Restaurante") || s.includes("Cafeter√≠a");
                return !s.includes("Restaurante") && !s.includes("Cafeter√≠a");
            });

            spaces.forEach((salon) => {
                const tr = document.createElement("tr");
                let tds = `<td style="font-weight:bold; padding:4px; position:sticky; left:0; background:#fff; z-index:4;">${salon}</td>`;

                for (let i = 0; i < 7; i++) {
                    const d = new Date(fVista);
                    d.setDate(d.getDate() + i);
                    const dStr = d.toISOString().split("T")[0];

                    const items = filtered.filter((x) => {
                        if (x.type !== tipoBusca || x.salon !== salon) return false;

                        // Restaurante: solo cuenta la fecha exacta
                        if (currentModule === "restaurante") {
                            return x.fechaInicio === dStr && x.estado !== "anulado";
                        }

                        // Salones: ocupar todos los d√≠as entre fechaInicio y fechaFin
                        const inicio = x.fechaInicio || dStr;
                        const fin = x.fechaFin || inicio;
                        return inicio <= dStr && dStr <= fin && x.estado !== "anulado";
                    });

                    if (currentModule === "restaurante") {
                        const alm = items
                            .filter((x) => x.turno === "manana")
                            .map(
                                (x) => `
                                <div class="mesa-card mesa-manana"
                                     onclick="event.stopPropagation(); abrirModalId('${x.id}')">
                                    <b>${x.hora || ""}</b> ${x.nombre || ""}${x.paxRest ? " ¬∑ " + x.paxRest + " pax" : ""}
                                </div>`
                            )
                            .join("");
                        const cen = items
                            .filter((x) => x.turno === "tarde")
                            .map(
                                (x) => `
                                <div class="mesa-card mesa-tarde"
                                     onclick="event.stopPropagation(); abrirModalId('${x.id}')">
                                    <b>${x.hora || ""}</b> ${x.nombre || ""}${x.paxRest ? " ¬∑ " + x.paxRest + " pax" : ""}
                                </div>`
                            )
                            .join("");

                        tds += `
                            <td class="cell-restaurante">
                                <div class="rest-zone" onclick="nuevoRest('${dStr}','${salon}','manana')">${alm}</div>
                                <div class="rest-zone" onclick="nuevoRest('${dStr}','${salon}','tarde')">${cen}</div>
                            </td>`;
                    } else {
                        let content = items
                            .map(
                                (x) => `
                                <div class="evt-box evt-full"
                                     onclick="event.stopPropagation(); abrirModalId('${x.id}')">
                                    ${
                                        x.turnoSalon === "manana"
                                            ? "‚òÄÔ∏è Ma√±ana ¬∑ "
                                            : x.turnoSalon === "tarde"
                                            ? "üåô Tarde ¬∑ "
                                            : x.turnoSalon === "dia"
                                            ? "üìÖ D√≠a completo ¬∑ "
                                            : ""
                                    }${x.nombre || ""}
                                </div>`
                            )
                            .join("");
                        if (!content) {
                            content =
                                '<div class="evt-box" style="opacity:0; pointer-events:none;">.</div>';
                        }
                        tds += `<td class="cell-salon" onclick="nuevoSalon('${dStr}','${salon}')">${content}</td>`;
                    }
                }

                tr.innerHTML = tds;
                tbody.appendChild(tr);
            });
        }

        function cerrarModal() {
            document.getElementById("modalFicha").style.display = "none";
        }

        function nuevoGeneral() {
            document.getElementById("dataId").value = "";
            document.getElementById("inpNombre").value = "";
            document.getElementById("inpTel").value = "";
            document.getElementById("inpEmail").value = "";
            document.getElementById("inpNotas").value = "";
            document.getElementById("bodyServicios").innerHTML = "";
            document.getElementById("totalAmount").innerText = "0.00";
            document.getElementById("inpHora").value = "";
            document.getElementById("inpPaxRest").value = "";
            const turnoSalonSelect = document.getElementById("inpTurnoSalon");
            if (turnoSalonSelect) turnoSalonSelect.value = "dia";

            const tipo =
                currentModule === "restaurante"
                    ? "restaurante"
                    : currentModule === "presupuestos"
                    ? "presupuesto"
                    : "evento";

            document.getElementById("dataType").value = tipo;

            const isRest = tipo === "restaurante";
            const isPpto = tipo === "presupuesto";
            const isEvento = tipo === "evento";

            document.getElementById("modalTitle").innerText = isRest
                ? "Nueva Mesa"
                : isPpto
                ? "Nuevo Presupuesto"
                : "Nuevo Evento";

            document.getElementById("blockRestaurante").style.display = isRest
                ? "block"
                : "none";
            document.getElementById("blockEventos").style.display = isRest
                ? "none"
                : "block";

            document.getElementById("grpFechaUnica").style.display =
                isPpto ? "none" : "block";
            document.getElementById("grpRangoFechas").style.display =
                isPpto ? "block" : "none";
            document.getElementById("blockEconomico").style.display =
                isRest ? "none" : "block";

            const sel = document.getElementById("inpSalon");
            sel.innerHTML = "";
            if (isPpto) {
                sel.innerHTML = `<option value="Pendiente">-- Pendiente --</option>`;
            }
            salones[currentHotel].forEach((s) => {
                if (isRest) {
                    if (s.includes("Restaurante") || s.includes("Cafeter√≠a"))
                        sel.innerHTML += `<option>${s}</option>`;
                } else {
                    if (!s.includes("Restaurante"))
                        sel.innerHTML += `<option>${s}</option>`;
                }
            });

            const hoy = new Date().toISOString().split("T")[0];
            document.getElementById("inpFecha").value = hoy;
            document.getElementById("inpFechaDesde").value = hoy;
            document.getElementById("inpFechaHasta").value = hoy;

            if (isPpto) addServiceRow({ date: hoy });

            document.getElementById("modalFicha").style.display = "flex";
        }

        function nuevoRest(fecha, salon, turno) {
            nuevoGeneral();
            document.getElementById("inpFecha").value = fecha;
            document.getElementById("inpSalon").value = salon;
            document.getElementById("inpTurno").value = turno;
        }

        function nuevoSalon(fecha, salon) {
            nuevoGeneral();
            document.getElementById("inpFecha").value = fecha;
            document.getElementById("inpSalon").value = salon;
        }

        function abrirModalId(id) {
            const item = dataCache.find((x) => x.id === id);
            if (!item) return;

            const tempModule = currentModule;
            currentModule =
                item.type === "restaurante"
                    ? "restaurante"
                    : item.type === "presupuesto"
                    ? "presupuestos"
                    : "eventos";
            nuevoGeneral();
            currentModule = tempModule;

            document.getElementById("dataId").value = item.id;
            document.getElementById("dataType").value = item.type;
            document.getElementById("inpNombre").value = item.nombre || "";
            document.getElementById("inpTel").value = item.tel || "";
            document.getElementById("inpEmail").value = item.email || "";
            document.getElementById("inpNotas").value = item.notas || "";
            document.getElementById("inpSalon").value = item.salon || "";

            if (item.type === "restaurante") {
                document.getElementById("inpHora").value = item.hora || "";
                document.getElementById("inpPaxRest").value = item.paxRest || "";
                document.getElementById("inpTurno").value = item.turno || "manana";
                document.getElementById("inpFecha").value =
                    item.fechaInicio || "";
            } else if (item.type === "presupuesto") {
                document.getElementById("inpFechaDesde").value =
                    item.fechaInicio || "";
                document.getElementById("inpFechaHasta").value =
                    item.fechaFin || "";
                document.getElementById("refPresupuesto").value = item.ref || "";
                const turnoSalonSelect = document.getElementById("inpTurnoSalon");
                if (turnoSalonSelect)
                    turnoSalonSelect.value = item.turnoSalon || "dia";
                document.getElementById("bodyServicios").innerHTML = "";
                if (item.servicios) item.servicios.forEach((s) => addServiceRow(s));
                updateTotal();
            } else {
                document.getElementById("inpFecha").value = item.fechaInicio || "";
                document.getElementById("inpPaxA").value = item.paxA || "";
                document.getElementById("inpPaxN").value = item.paxN || "";
                document.getElementById("inpMontaje").value =
                    item.montaje || "Banquete";
                const turnoSalonSelect = document.getElementById("inpTurnoSalon");
                if (turnoSalonSelect)
                    turnoSalonSelect.value = item.turnoSalon || "dia";

                // Si el evento viene de un presupuesto, puede tener desglose econ√≥mico
                document.getElementById("bodyServicios").innerHTML = "";
                if (item.servicios && item.servicios.length) {
                    item.servicios.forEach((s) => addServiceRow(s));
                }
                updateTotal();
            }
        }

        function addServiceRow(data = {}) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><input type="date" class="s-date svc-input" value="${data.date || ""}"></td>
                <td><input type="text" class="s-desc svc-input" value="${data.desc || ""}"></td>
                <td><input type="number" class="s-uds svc-input" value="${data.uds || ""}"></td>
                <td><input type="number" step="0.01" class="s-price svc-input" value="${data.price || ""}"></td>
                <td><input type="number" step="0.01" class="s-total svc-input" value="${data.total || ""}"></td>
                <td><button type="button" class="btn-small" onclick="this.closest('tr').remove(); updateTotal();">√ó</button></td>
            `;
            tr.querySelectorAll("input").forEach((inp) =>
                inp.addEventListener("input", updateTotal)
            );
            document.getElementById("bodyServicios").appendChild(tr);
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            document.querySelectorAll("#bodyServicios tr").forEach((tr) => {
                const uds = parseFloat(tr.querySelector(".s-uds").value) || 0;
                const price = parseFloat(tr.querySelector(".s-price").value) || 0;
                const t = uds * price;
                tr.querySelector(".s-total").value = t.toFixed(2);
                total += t;
            });
            document.getElementById("totalAmount").innerText = total.toFixed(2);
        }

        function guardarFicha(estadoOverride, skipClose) {
    try {
        const id = document.getElementById("dataId").value;
        const type = document.getElementById("dataType").value;
        const nombre = document.getElementById("inpNombre").value;
        if (!nombre) {
            alert("El nombre es obligatorio.");
            return Promise.reject(new Error("Nombre obligatorio"));
        }

        const data = {
            hotel: currentHotel,
            type,
            nombre,
            tel: document.getElementById("inpTel").value,
            email: document.getElementById("inpEmail").value,
            salon: document.getElementById("inpSalon").value,
            notas: document.getElementById("inpNotas").value,
            estado: estadoOverride || "activo"
        };

        if (type === "restaurante") {
            data.hora = document.getElementById("inpHora").value;
            data.paxRest = document.getElementById("inpPaxRest").value;
            data.turno = document.getElementById("inpTurno").value;
            data.fechaInicio = document.getElementById("inpFecha").value;
            data.fechaFin = data.fechaInicio;
        } else if (type === "presupuesto") {
            data.fechaInicio =
                document.getElementById("inpFechaDesde").value;
            data.fechaFin = document.getElementById("inpFechaHasta").value;
            data.turnoSalon = document.getElementById("inpTurnoSalon").value || "dia";
            data.total = document.getElementById("totalAmount").innerText;
            data.servicios = [];
            document
                .querySelectorAll("#bodyServicios tr")
                .forEach((tr) =>
                    data.servicios.push({
                        date: tr.querySelector(".s-date").value,
                        desc: tr.querySelector(".s-desc").value,
                        uds: tr.querySelector(".s-uds").value,
                        price: tr.querySelector(".s-price").value,
                        total: tr.querySelector(".s-total").value
                    })
                );
            if (!id) data.ref = "PRE-" + Date.now();
        } else {
            data.fechaInicio = document.getElementById("inpFecha").value;
            data.fechaFin = data.fechaInicio;
            data.paxA = document.getElementById("inpPaxA").value;
            data.paxN = document.getElementById("inpPaxN").value;
            data.montaje = document.getElementById("inpMontaje").value;
            data.turnoSalon = document.getElementById("inpTurnoSalon").value || "dia";

            // Si el evento tiene desglose econ√≥mico, lo guardamos igual que en los presupuestos
            const filas = document.querySelectorAll("#bodyServicios tr");
            if (filas.length) {
                data.total = document.getElementById("totalAmount").innerText;
                data.servicios = [];
                filas.forEach((tr) =>
                    data.servicios.push({
                        date: tr.querySelector(".s-date").value,
                        desc: tr.querySelector(".s-desc").value,
                        uds: tr.querySelector(".s-uds").value,
                        price: tr.querySelector(".s-price").value,
                        total: tr.querySelector(".s-total").value
                    })
                );
            }
        }

        if (id) {
            return db
                .collection("master_data")
                .doc(id)
                .update(data)
                .then(() => {
                    if (!skipClose) cerrarModal();
                    return id;
                });
        } else {
            return db
                .collection("master_data")
                .add(data)
                .then((ref) => {
                    document.getElementById("dataId").value = ref.id;
                    if (!skipClose) cerrarModal();
                    return ref.id;
                });
        }
    } catch (e) {
        alert("Error al guardar: " + e.message);
        return Promise.reject(e);
    }
}

        function anularFicha() {
            const id = document.getElementById("dataId").value;
            if (id && confirm("¬øAnular registro?")) {
                db.collection("master_data")
                    .doc(id)
                    .update({ estado: "anulado" })
                    .then(() => cerrarModal());
            }
        }

        function imprimirPDF() {
            // Generador de PDF/impresi√≥n para el presupuesto activo
            if (document.getElementById("dataType").value !== "presupuesto") {
                alert("Solo se puede generar el PDF desde un presupuesto.");
                return;
            }

            const hotel = currentHotel || document.getElementById("tituloHotelActual").innerText || "";
            const logoSrc =
                hotel === "Guadiana"
                    ? "Img/logo-guadiana.svg"
                    : "Img/logo-cumbria.svg";

            const nombre = document.getElementById("inpNombre").value || "";
            const tel = document.getElementById("inpTel").value || "";
            const email = document.getElementById("inpEmail").value || "";
            const salon = document.getElementById("inpSalon").value || "";
            const notas = document.getElementById("inpNotas").value || "";
            const fechaDesde = document.getElementById("inpFechaDesde").value || "";
            const fechaHasta = document.getElementById("inpFechaHasta").value || "";
            const ref = document.getElementById("refPresupuesto").value || "";
            const fechaEmision =
                document.getElementById("fechaEmision").value ||
                new Date().toLocaleDateString("es-ES");
            const paxA = document.getElementById("inpPaxA")
                ? document.getElementById("inpPaxA").value
                : "";
            const paxN = document.getElementById("inpPaxN")
                ? document.getElementById("inpPaxN").value
                : "";
            const montaje = document.getElementById("inpMontaje")
                ? document.getElementById("inpMontaje").value
                : "";

            // Detalle econ√≥mico
            const filas = Array.from(
                document.querySelectorAll("#bodyServicios tr")
            ).map((tr) => ({
                date: tr.querySelector(".s-date").value,
                desc: tr.querySelector(".s-desc").value,
                uds: tr.querySelector(".s-uds").value,
                price: tr.querySelector(".s-price").value,
                total: tr.querySelector(".s-total").value
            }));

            const total = document.getElementById("totalAmount").innerText || "";

            const w = window.open("", "_blank");
            if (!w) {
                alert(
                    "El navegador ha bloqueado la ventana emergente. Permite las ventanas emergentes para generar el PDF."
                );
                return;
            }

            let filasHtml = "";
            filas.forEach((f) => {
                filasHtml +=
                    "<tr>" +
                    "<td>" +
                    (f.date || "") +
                    "</td>" +
                    "<td>" +
                    (f.desc || "") +
                    "</td>" +
                    "<td style='text-align:right;'>" +
                    (f.uds || "") +
                    "</td>" +
                    "<td style='text-align:right;'>" +
                    (f.price || "") +
                    "</td>" +
                    "<td style='text-align:right;'>" +
                    (f.total || "") +
                    "</td>" +
                    "</tr>";
            });

            const rangoFechas =
                fechaDesde &&
                fechaHasta &&
                fechaHasta !== fechaDesde
                    ? fechaDesde + " - " + fechaHasta
                    : fechaDesde || fechaHasta || "";

            const notasHtml = notas
                ? '<div class="section-title">Observaciones</div><div class="notas">' +
                  notas.replace(/\n/g, "<br>") +
                  "</div>"
                : "";

            const htmlDoc = `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Presupuesto ${ref ? "#" + ref : ""}</title>
<style>
  @page {
    margin: 20mm;
  }
  body {
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    margin: 0;
    padding: 20px 24px;
    color: #333;
    background: #ffffff;
  }
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 12px;
  }
  .header-logo img {
    height: 52px;
  }
  .header-text {
    text-align: right;
  }
  .header-text-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .section-title {
    font-size: 14px;
    font-weight: 600;
    margin: 18px 0 8px 0;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  .meta td {
    border: 1px solid #e0e0e0;
    padding: 6px 8px;
    vertical-align: top;
  }
  .detalle th,
  .detalle td {
    border: 1px solid #e0e0e0;
    padding: 6px 8px;
  }
  .detalle th {
    background: #f5f5f5;
    text-align: left;
  }
  .total-row td {
    font-weight: 600;
  }
  .notas {
    border: 1px solid #e0e0e0;
    padding: 8px 10px;
    border-radius: 4px;
    font-size: 12px;
  }
  .footer {
    margin-top: 24px;
    font-size: 10px;
    color: #777;
    border-top: 1px solid #e0e0e0;
    padding-top: 8px;
  }
</style>
</head>
<body>
<div class="header">
  <div class="header-logo">
    <img src="${logoSrc}" alt="${hotel}">
  </div>
  <div class="header-text">
    <div class="header-text-title">${
        hotel === "Guadiana" ? "Sercotel Guadiana" : "Cumbria Spa & Hotel"
    }</div>
    <div>Presupuesto ${ref ? "#" + ref : ""}</div>
    <div>Emitido: ${fechaEmision}</div>
  </div>
</div>

<div class="section-title">Datos del cliente / evento</div>
<table class="meta">
  <tr>
    <td><strong>Cliente / Evento</strong><br>${nombre}</td>
    <td><strong>Tel√©fono</strong><br>${tel}</td>
    <td><strong>Email</strong><br>${email}</td>
  </tr>
  <tr>
    <td><strong>Espacio / Sal√≥n</strong><br>${salon || "Pendiente"}</td>
    <td><strong>Fechas</strong><br>${rangoFechas}</td>
    <td><strong>N¬∫ Presupuesto</strong><br>${ref}</td>
  </tr>
  <tr>
    <td><strong>Montaje</strong><br>${montaje}</td>
    <td colspan="2"><strong>Pax banquete</strong><br>Adultos: ${paxA || "-"} ¬∑ Ni√±os: ${paxN || "-"}</td>
  </tr>
</table>

<div class="section-title">Detalle econ√≥mico</div>
<table class="detalle">
  <thead>
    <tr>
      <th style="width:16%;">Fecha</th>
      <th>Descripci√≥n</th>
      <th style="width:10%; text-align:right;">Uds.</th>
      <th style="width:14%; text-align:right;">Precio</th>
      <th style="width:16%; text-align:right;">Importe</th>
    </tr>
  </thead>
  <tbody>
    ${filasHtml}
    <tr class="total-row">
      <td colspan="4" style="text-align:right;">TOTAL</td>
      <td style="text-align:right;">${total}</td>
    </tr>
  </tbody>
</table>

${notasHtml}

<div class="footer">
  Este documento es una propuesta econ√≥mica orientativa. La reserva solo quedar√° garantizada una vez recibida la confirmaci√≥n por escrito y el anticipo acordado.
</div>
</body>
</html>`;

            w.document.open();
            w.document.write(htmlDoc);
            w.document.close();
            w.focus();
            w.print();
        }

function confirmarPresupuesto() {
    if (document.getElementById("dataType").value !== "presupuesto") return;

    const salon = document.getElementById("inpSalon").value;
    if (
        !salon ||
        salon === "Pendiente" ||
        salon.startsWith("--")
    ) {
        alert("Para confirmar el presupuesto debes indicar en qu√© sal√≥n se va a realizar.");
        return;
    }

    const nombre = document.getElementById("inpNombre").value;
    if (!nombre) {
        alert("El nombre del cliente/evento es obligatorio.");
        return;
    }

    const fechaInicio = document.getElementById("inpFechaDesde").value;
    const fechaFin =
        document.getElementById("inpFechaHasta").value || fechaInicio;

    const eventoData = {
        hotel: currentHotel,
        type: "evento",
        nombre,
        salon,
        fechaInicio,
        fechaFin,
        paxA: document.getElementById("inpPaxA").value,
        paxN: document.getElementById("inpPaxN").value,
        montaje: document.getElementById("inpMontaje").value,
        turnoSalon: document.getElementById("inpTurnoSalon").value || "dia",
        notas: document.getElementById("inpNotas").value,
        estado: "confirmado"
    };

    // Copiamos el desglose econ√≥mico del presupuesto al evento confirmado
    const servicios = [];
    document.querySelectorAll("#bodyServicios tr").forEach((tr) => {
        servicios.push({
            date: tr.querySelector(".s-date").value,
            desc: tr.querySelector(".s-desc").value,
            uds: tr.querySelector(".s-uds").value,
            price: tr.querySelector(".s-price").value,
            total: tr.querySelector(".s-total").value
        });
    });
    if (servicios.length) {
        eventoData.servicios = servicios;
        eventoData.total = document.getElementById("totalAmount").innerText;
    }

    // 1) Guardamos/actualizamos el presupuesto con estado "confirmado"
    // 2) Creamos el evento en el planning de salones
    guardarFicha("confirmado", true)
        .then((pptoId) => {
            eventoData.refPresupuesto = pptoId; // v√≠nculo
            return db.collection("master_data").add(eventoData);
        })
        .then(() => {
            alert("Presupuesto confirmado y enviado al planning de salones.");
            cerrarModal();
        })
        .catch((e) => {
            console.error(e);
            alert("No se ha podido confirmar el presupuesto.");
        });
}

        async function callGemini(prompt) {
            if (!apiKey) return alert("Configura la API Key de Gemini.");
            const url =
                "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" +
                apiKey;

            const payload = {
                contents: [
                    {
                        parts: [{ text: prompt }]
                    }
                ]
            };

            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const d = await res.json();
                return d.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch {
                return null;
            }
        }

        async function mejorarNotasConIA() {
            const input = document.getElementById("inpNotas");
            const original = input.value;
            if (!original.trim()) return alert("Escribe algo primero.");
            input.value = "Mejorando redacci√≥n...";
            const res = await callGemini(
                "Reescribe estas notas de evento de forma profesional y clara: " +
                    original
            );
            if (!res) {
                alert("No se ha podido obtener respuesta de la IA.");
                input.value = original;
                return;
            }
            input.value = res.trim();
        }

        async function redactarEmailIA() {
            if (document.getElementById("dataType").value !== "presupuesto") {
                alert("Esta funci√≥n est√° pensada para presupuestos.");
                return;
            }

            const nombre = document.getElementById("inpNombre").value;
            const salon = document.getElementById("inpSalon").value;
            const fechas =
                document.getElementById("inpFechaDesde").value +
                " al " +
                document.getElementById("inpFechaHasta").value;
            const total = document.getElementById("totalAmount").innerText;

            const prompt = `
Redacta un email breve y profesional para enviar a un cliente un presupuesto de evento en hotel,
en espa√±ol neutro. Datos:
- Cliente / evento: ${nombre}
- Hotel: ${currentHotel}
- Sal√≥n: ${salon}
- Fechas: ${fechas}
- Importe aproximado: ${total} ‚Ç¨

Indica que se adjunta el presupuesto detallado en PDF, invita a consultar dudas
y evita cerrar con f√≥rmulas demasiado recargadas.`;

            const out = document.getElementById("aiOutput");
            out.value = "Generando propuesta de email...";
            const texto = await callGemini(prompt);
            if (!texto) {
                out.value =
                    "No se ha podido obtener una sugerencia en este momento.";
                return;
            }
            out.value = texto.trim();
            document.getElementById("aiResponseModal").style.display = "flex";
        }

        function cerrarAiModal() {
            document.getElementById("aiResponseModal").style.display = "none";
        }

        function aceptarTextoIA() {
            const texto = document.getElementById("aiOutput").value;
            if (!texto.trim()) return;
            const notas = document.getElementById("inpNotas");
            notas.value =
                (notas.value ? notas.value + "\n\n" : "") + "[Texto email]\n" + texto;
            cerrarAiModal();
        }

        function copiarTextoIA() {
            const texto = document.getElementById("aiOutput");
            texto.select();
            document.execCommand("copy");
            alert("Texto copiado");
        }
    </script>
</body>
</html>
