<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - MesaChef</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #263238;
            --accent: #10b981;
            --bg: #f3f4f6;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1f2937; }
        
        /* LOGIN MODAL */
        #loginOverlay {
            position: fixed; inset: 0; background: #263238; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 12px; width: 300px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        .login-box h2 { margin-top: 0; color: var(--primary); }
        .login-input { width: 100%; padding: 10px; margin: 15px 0; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px; outline: none; text-align: center;}
        .login-input:focus { border-color: var(--accent); }
        .btn-login { background: var(--accent); color: white; width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; }

        /* LAYOUT PRINCIPAL */
        .container { max-width: 1100px; margin: 0 auto; display: none; /* Oculto hasta login */ }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-back { text-decoration: none; color: #4b5563; font-weight: 600; display: flex; align-items: center; gap: 5px; background: white; padding: 8px 15px; border-radius: 99px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        
        /* TARJETAS DE CONFIG */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #e5e7eb; }
        .card h3 { margin-top: 0; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; color: var(--primary); display: flex; align-items: center; gap: 8px; font-size: 16px; }
        .full-width { grid-column: 1 / -1; }

        /* FORMULARIOS */
        label { display: block; font-size: 12px; font-weight: 700; color: #6b7280; margin-bottom: 4px; text-transform: uppercase; }
        input[type="text"], input[type="number"], input[type="time"], select, textarea {
            width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; margin-bottom: 10px; box-sizing: border-box;
        }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; }
        
        .row-horarios { display: flex; gap: 15px; }
        .alert-info { background: #eff6ff; color: #1e40af; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 5px; border: 1px solid #dbeafe; }

        /* TABLA SALONES */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; background: #f9fafb; padding: 10px; border-bottom: 1px solid #e5e7eb; color: #374151; }
        td { padding: 8px; border-bottom: 1px solid #f3f4f6; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 16px; }
        .btn-add { background: #f3f4f6; border: 1px dashed #9ca3af; color: #4b5563; width: 100%; padding: 8px; margin-top: 10px; border-radius: 6px; cursor: pointer; }
        
        /* MONTAJES */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .tag { background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 99px; font-size: 12px; display: flex; align-items: center; gap: 6px; }
        .tag-close { cursor: pointer; font-weight: bold; }

        /* BOT√ìN FLOTANTE GUARDAR */
        .fab-save {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--primary); color: white;
            padding: 15px 30px; border-radius: 99px;
            font-weight: bold; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: none; cursor: pointer; transition: transform 0.2s;
            display: flex; align-items: center; gap: 10px; z-index: 100;
        }
        .fab-save:hover { transform: translateY(-3px); background: #1f2937; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2>üîí Acceso Admin</h2>
            <p style="font-size:13px; color:#666;">Introduce la contrase√±a maestra</p>
            <input type="password" id="passInput" class="login-input" placeholder="Contrase√±a...">
            <button class="btn-login" onclick="checkPassword()">Entrar</button>
            <p id="errorMsg" style="color:red; font-size:12px; margin-top:10px; display:none;">Contrase√±a incorrecta</p>
        </div>
    </div>

    <div class="container" id="adminPanel">
        
        <div class="header-bar">
            <a href="index.html" class="btn-back">‚¨Ö Volver a la App</a>
            <h1 style="font-size: 20px; color: var(--primary); margin:0;">‚öôÔ∏è Configuraci√≥n Global</h1>
            <div style="background: #fff; padding: 5px 15px; border-radius: 8px; border:1px solid #ddd;">
                <span style="font-size:11px; font-weight:bold; color:#666; margin-right:5px;">EDITANDO:</span>
                <select id="hotelSelector" onchange="cargarConfig()" style="border:none; font-weight:bold; font-size:14px; margin:0; width:auto; outline:none;">
                    <option value="Guadiana">Sercotel Guadiana</option>
                    <option value="Cumbria">Cumbria Spa&Hotel</option>
                </select>
            </div>
        </div>

        <div class="grid-layout">
            
            <div class="card">
                <h3>‚è±Ô∏è Horarios Restaurante</h3>
                <div class="row-horarios">
                    <div style="flex:1">
                        <label>Apertura Almuerzo</label>
                        <input type="time" id="confAlmIni">
                    </div>
                    <div style="flex:1">
                        <label>Cierre Almuerzo</label>
                        <input type="time" id="confAlmFin">
                    </div>
                </div>
                <div class="row-horarios">
                    <div style="flex:1">
                        <label>Apertura Cena</label>
                        <input type="time" id="confCenaIni">
                    </div>
                    <div style="flex:1">
                        <label>Cierre Cena</label>
                        <input type="time" id="confCenaFin">
                    </div>
                </div>
                <hr style="border:0; border-top:1px dashed #eee; margin:10px 0;">
                <label>Corte Visual (Cambio de Columna)</label>
                <input type="time" id="confCorte">
                <div class="alert-info">A partir de esta hora, las reservas se ver√°n en la columna de Tarde/Cena.</div>
            </div>

            <div class="card">
                <h3>ü™ë Tipos de Montaje</h3>
                <p style="font-size:12px; color:#666; margin-bottom:10px;">Opciones disponibles en el desplegable de eventos.</p>
                <div class="tags-container" id="containerMontajes"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="newMontaje" placeholder="Nuevo montaje..." style="margin:0;">
                    <button onclick="addMontaje()" style="background:var(--primary); color:white; border:none; padding:0 15px; border-radius:6px;">+</button>
                </div>
            </div>

            <div class="card">
                <h3>ü§ñ Inteligencia Artificial</h3>
                <label>Tono de comunicaci√≥n</label>
                <select id="confIATone">
                    <option value="formal">Muy Formal (Usted)</option>
                    <option value="cercano">Cercano y Comercial (T√∫)</option>
                    <option value="lujo">Exclusivo / Lujo</option>
                    <option value="tecnico">T√©cnico y Directo</option>
                </select>
                <label>Instrucci√≥n extra (Prompt)</label>
                <textarea id="confIAPrompt" rows="2" placeholder="Ej: Mencionar siempre que el parking es gratuito..."></textarea>
            </div>

            <div class="card" style="border-color: #fca5a5; background: #fef2f2;">
                <h3 style="color: #b91c1c;">üîí Seguridad</h3>
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin-top:10px; color:#b91c1c;">
                    <input type="checkbox" id="confMantenimiento" style="width:auto; margin:0;">
                    ACTIVAR MODO MANTENIMIENTO
                </label>
                <p style="font-size:11px; color:#7f1d1d; margin-top:5px;">
                    Si activas esto, la App principal mostrar√° un aviso de "En Obras" y nadie podr√° acceder.
                </p>
            </div>

            <div class="card full-width">
                <h3>üè® Gesti√≥n de Salones y Tarifas</h3>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre del Espacio</th>
                                <th width="70">m¬≤</th> <th width="80">Pax M√°x</th>
                                <th width="100">‚Ç¨ 1/2 D√≠a</th>
                                <th width="100">‚Ç¨ Comp.</th>
                                <th width="60" style="text-align:center">Activo</th>
                                <th width="40"></th>
                            </tr>
                        </thead>
                        <tbody id="bodySalones"></tbody>
                    </table>
                </div>
                <button class="btn-add" onclick="addSalonRow()">+ A√±adir nuevo sal√≥n</button>
            </div>

            <div class="card full-width">
                <h3>üìÑ Legal y Condiciones (PDF)</h3>
                <textarea id="confLegal" rows="5" style="font-family:monospace; font-size:12px;"></textarea>
                <div class="alert-info">Este texto aparecer√° al pie de todos los presupuestos generados.</div>
            </div>

        </div> <br><br><br> </div>

    <button class="fab-save" onclick="guardarTodo()" id="btnGuardar" style="display:none;">
        üíæ GUARDAR CAMBIOS
    </button>

    <script>
        /* --- 1. CONFIGURACI√ìN FIREBASE --- */
        const firebaseConfig = {
            apiKey: "AIzaSyBAK0sGUYpV8KHy1KwIdNRLtHlq5LT3Vwg",
            authDomain: "gestionsalones-bba4b.firebaseapp.com",
            projectId: "gestionsalones-bba4b",
            storageBucket: "gestionsalones-bba4b.firebasestorage.app",
            messagingSenderId: "860164285474",
            appId: "1:860164285474:web:ff995e88093e5aa5eb167b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        /* --- 2. GESTI√ìN DE ACCESO --- */
        const MASTER_PASS = "mesachef2026";

        function checkPassword() {
            const input = document.getElementById("passInput");
            const error = document.getElementById("errorMsg");
            
            if (input.value === MASTER_PASS) {
                document.getElementById("loginOverlay").style.display = "none";
                document.getElementById("adminPanel").style.display = "block";
                document.getElementById("btnGuardar").style.display = "flex";
                cargarConfig(); // Cargar datos al entrar
            } else {
                error.style.display = "block";
                input.value = "";
                input.focus();
            }
        }
        
        document.getElementById("passInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") checkPassword();
        });

        /* --- 3. L√ìGICA DEL PANEL --- */
        let fullConfig = {}; 
        let currentHotel = "Guadiana";

        /* --- DATOS OFICIALES --- */
        const salonesGuadianaDefault = [
            { name: "Puerta de Alarcos", size: 570, pax: 800, priceHalf: 0, priceFull: 0, active: true },
            { name: "Puerta de Calatrava", size: 125, pax: 135, priceHalf: 0, priceFull: 0, active: true },
            { name: "Puerta del Carmen", size: 110, pax: 120, priceHalf: 0, priceFull: 0, active: true },
            { name: "Puerta de Ciruela", size: 25, pax: 20, priceHalf: 0, priceFull: 0, active: true },
            { name: "Puerta de Granada", size: 120, pax: 135, priceHalf: 0, priceFull: 0, active: true },
            { name: "Puerta de Santa Mar√≠a", size: 70, pax: 80, priceHalf: 0, priceFull: 0, active: true },
            { name: "Puerta de Toledo", size: 150, pax: 160, priceHalf: 0, priceFull: 0, active: true }
        ];

        const salonesCumbriaDefault = [
            { name: "Sal√≥n Mercurio", size: 77, pax: 90, priceHalf: 0, priceFull: 0, active: true },
            { name: "Sal√≥n Venus", size: 77, pax: 90, priceHalf: 0, priceFull: 0, active: true },
            { name: "Sal√≥n La Tierra", size: 68, pax: 70, priceHalf: 0, priceFull: 0, active: true },
            { name: "Sal√≥n Marte", size: 77, pax: 90, priceHalf: 0, priceFull: 0, active: true },
            { name: "Sal√≥n J√∫piter", size: 68, pax: 70, priceHalf: 0, priceFull: 0, active: true }
        ];

        function cargarConfig() {
            currentHotel = document.getElementById("hotelSelector").value;
            console.log("Cargando...", currentHotel);

            db.collection("master_data").doc("CONFIG_SALONES").get().then((doc) => {
                if (doc.exists) {
                    fullConfig = doc.data();
                    if (currentHotel === "Guadiana" && (!fullConfig.Guadiana || fullConfig.Guadiana.length === 0)) {
                        fullConfig.Guadiana = salonesGuadianaDefault;
                    }
                    if (currentHotel === "Cumbria" && (!fullConfig.Cumbria || fullConfig.Cumbria.length === 0)) {
                        fullConfig.Cumbria = salonesCumbriaDefault;
                    }
                } else {
                    fullConfig = { Guadiana: salonesGuadianaDefault, Cumbria: salonesCumbriaDefault, horarios: {} };
                }
                renderInterface();
            }).catch(e => alert("Error conectando: " + e.message));
        }

        function renderInterface() {
            // A. Horarios
            const h = fullConfig.horarios || { almIni: "13:00", almFin: "16:00", cenaIni: "20:30", cenaFin: "23:00", corte: "18:00" };
            document.getElementById("confAlmIni").value = h.almIni;
            document.getElementById("confAlmFin").value = h.almFin;
            document.getElementById("confCenaIni").value = h.cenaIni;
            document.getElementById("confCenaFin").value = h.cenaFin;
            document.getElementById("confCorte").value = h.corte || "18:00";

            // B. Salones
            const tbody = document.getElementById("bodySalones");
            tbody.innerHTML = "";
            const salones = fullConfig[currentHotel] || [];
            
            salones.forEach((s, i) => {
                // Formateo inicial para visualizar: 150.00 ‚Ç¨
                let pFull = (parseFloat(s.priceFull)||0).toFixed(2) + " ‚Ç¨";
                let pHalf = (parseFloat(s.priceHalf)||0).toFixed(2) + " ‚Ç¨";

                tbody.innerHTML += `
                    <tr>
                        <td><input type="text" value="${s.name}" onchange="updSalon(${i}, 'name', this.value)" style="margin:0"></td>
                        <td><input type="number" value="${s.size || 0}" onchange="updSalon(${i}, 'size', this.value)" style="margin:0; background:#f9fafb;"></td>
                        <td><input type="number" value="${s.pax}" onchange="updSalon(${i}, 'pax', this.value)" style="margin:0; font-weight:bold;"></td>
                        
                        <td>
                            <input type="text" 
                                   value="${pHalf}" 
                                   onfocus="this.select()" 
                                   onchange="formatAdminPrice(this, ${i}, 'priceHalf')" 
                                   style="margin:0; text-align:right;">
                        </td>
                        <td>
                            <input type="text" 
                                   value="${pFull}" 
                                   onfocus="this.select()" 
                                   onchange="formatAdminPrice(this, ${i}, 'priceFull')" 
                                   style="margin:0; text-align:right;">
                        </td>

                        <td style="text-align:center"><input type="checkbox" ${s.active ? 'checked' : ''} onchange="updSalon(${i}, 'active', this.checked)"></td>
                        <td style="text-align:center"><button class="btn-icon" onclick="delSalon(${i})" style="color:red">‚úï</button></td>
                    </tr>`;
            });

            // C. Montajes
            const montajes = fullConfig.montajes || ["Banquete", "Escuela", "Teatro", "C√≥ctel", "U", "Imperial"];
            const divM = document.getElementById("containerMontajes");
            divM.innerHTML = montajes.map((m, i) => 
                `<div class="tag">${m} <span class="tag-close" onclick="delMontaje(${i})">√ó</span></div>`
            ).join("");

            document.getElementById("confLegal").value = fullConfig.textoLegal || "";
            document.getElementById("confMantenimiento").checked = fullConfig.mantenimiento || false;
            
            const ai = fullConfig.aiOptions || {};
            document.getElementById("confIATone").value = ai.tone || "formal";
            document.getElementById("confIAPrompt").value = ai.prompt || "";
        }

        /* --- HELPERS DE ACTUALIZACI√ìN --- */
        function updSalon(idx, field, val) { fullConfig[currentHotel][idx][field] = val; }
        
        // NUEVA FUNCI√ìN: Formatea el precio al salir de la casilla y actualiza el dato num√©rico
        function formatAdminPrice(el, idx, field) {
            // 1. Limpiar lo que haya escrito el usuario (quitar ‚Ç¨, espacios y cambiar comas)
            let raw = el.value.replace(' ‚Ç¨', '').replace('‚Ç¨', '').replace(',', '.');
            let val = parseFloat(raw);
            
            if(isNaN(val)) val = 0;

            // 2. Guardar en memoria como N√öMERO PURO
            fullConfig[currentHotel][idx][field] = val;

            // 3. Mostrar bonito en pantalla
            el.value = val.toFixed(2) + " ‚Ç¨";
        }

        function addSalonRow() {
            if(!fullConfig[currentHotel]) fullConfig[currentHotel] = [];
            fullConfig[currentHotel].push({ name: "Nuevo Espacio", size: 0, pax: 0, priceHalf: 0, priceFull: 0, active: true });
            renderInterface();
        }
        
        function delSalon(idx) {
            if(confirm("¬øEliminar este sal√≥n?")) {
                fullConfig[currentHotel].splice(idx, 1);
                renderInterface();
            }
        }

        function addMontaje() {
            const val = document.getElementById("newMontaje").value.trim();
            if(val) {
                if(!fullConfig.montajes) fullConfig.montajes = [];
                fullConfig.montajes.push(val);
                document.getElementById("newMontaje").value = "";
                renderInterface();
            }
        }
        
        function delMontaje(idx) {
            fullConfig.montajes.splice(idx, 1);
            renderInterface();
        }

        /* --- GUARDADO GLOBAL --- */
        function guardarTodo() {
            // LIMPIEZA DE SEGURIDAD ANTES DE ENVIAR
            if(fullConfig[currentHotel]) {
                fullConfig[currentHotel].forEach(s => {
                    // Nos aseguramos de que todo se guarde como n√∫mero
                    s.pax = parseInt(s.pax) || 0;
                    s.size = parseInt(s.size) || 0;
                    
                    // Limpieza extra por si acaso
                    let ph = String(s.priceHalf).replace(',', '.').replace(' ‚Ç¨', '').replace('‚Ç¨', '');
                    let pf = String(s.priceFull).replace(',', '.').replace(' ‚Ç¨', '').replace('‚Ç¨', '');
                    
                    s.priceHalf = parseFloat(ph) || 0;
                    s.priceFull = parseFloat(pf) || 0;
                });
            }

            fullConfig.horarios = {
                almIni: document.getElementById("confAlmIni").value,
                almFin: document.getElementById("confAlmFin").value,
                cenaIni: document.getElementById("confCenaIni").value,
                cenaFin: document.getElementById("confCenaFin").value,
                corte: document.getElementById("confCorte").value
            };

            fullConfig.textoLegal = document.getElementById("confLegal").value;
            fullConfig.mantenimiento = document.getElementById("confMantenimiento").checked;
            
            fullConfig.aiOptions = {
                tone: document.getElementById("confIATone").value,
                prompt: document.getElementById("confIAPrompt").value
            };

            db.collection("master_data").doc("CONFIG_SALONES").set(fullConfig)
                .then(() => {
                    const btn = document.getElementById("btnGuardar");
                    const prevText = btn.innerText;
                    btn.innerText = "‚úÖ ¬°GUARDADO!";
                    btn.style.background = "#059669";
                    setTimeout(() => {
                        btn.innerText = prevText;
                        btn.style.background = "";
                    }, 2000);
                })
                .catch(e => alert("Error guardando: " + e.message));
        }
    </script>
</body>
</html>