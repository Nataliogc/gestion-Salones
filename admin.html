<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>MesaChef Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" href="Img/mesa-chef-192.png" />
    <link rel="apple-touch-icon" href="Img/mesa-chef-192.png" />
    <style>
        /* LOGIN (CSS Dependencies Free) */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: #f3f4f6;
        }

        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111827;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            width: 90%;
            max-width: 380px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .inp {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .err {
            color: red;
            margin-top: 10px;
            display: none;
        }

        /* APP */
        .hidden {
            display: none !important;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .card h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            color: #374151;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: #6b7280;
            margin-top: 8px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>

    <!-- LOGIN -->
    <div id="loginScreen">
        <div class="login-card">
            <div style="font-size:3rem; margin-bottom:10px;">üîê</div>
            <h2 style="margin:0 0 20px 0;">Acceso Admin</h2>
            <input type="password" id="passInput" class="inp" placeholder="Contrase√±a..." autofocus>
            <button onclick="checkPass()" id="btnLogin" class="btn">ENTRAR</button>
            <p id="errorMsg" class="err">Contrase√±a incorrecta</p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
        <script src="https://cdn.tailwindcss.com"></script>

        <div class="min-h-screen bg-gray-100 pb-20 font-sans">
            <!-- Header -->
            <nav class="bg-white shadow-sm sticky top-0 z-40 border-b border-gray-200 h-14">
                <div class="max-w-[98%] mx-auto px-4 h-full">
                    <div class="flex justify-between items-center h-full">
                        <!-- LEFT: SYSTEM IDENTITY -->
                        <div class="flex items-center gap-4">
                            <!-- Brand -->
                            <div class="flex items-center gap-3">
                                <img src="Img/logo_mesa_chef.png" class="h-8 w-auto object-contain drop-shadow-sm"
                                    alt="MesaChef">
                                <div class="flex flex-col leading-none">
                                    <h1 class="text-slate-800 font-bold text-lg tracking-tight">MesaChef</h1>
                                    <span
                                        class="text-[10px] text-blue-600 font-bold uppercase tracking-widest -mt-0.5">Enterprise</span>
                                </div>
                            </div>
                            <!-- Divider -->
                            <div class="h-6 w-px bg-slate-200"></div>
                            <!-- Module Indicator -->
                            <span
                                class="text-slate-500 font-semibold text-sm tracking-wide uppercase">Configuraci√≥n</span>
                        </div>

                        <!-- CENTER: STATIC TITLE FOR ADMIN -->
                        <div class="flex items-center gap-6">
                            <!-- Connection Status -->
                            <div class="flex items-center gap-2 px-3 py-0.5 bg-green-50 rounded-full border border-green-100"
                                id="connStatus">
                                <div
                                    class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_6px_rgba(34,197,94,0.6)]">
                                </div>
                                <span class="text-[10px] font-bold text-green-700 uppercase tracking-wide">Online</span>
                            </div>

                            <!-- Static Title -->
                            <div id="headerHotelName" class="text-sm font-semibold text-slate-700 flex items-center">
                                <span class="text-lg">‚öôÔ∏è Configuraci√≥n Global</span>
                            </div>
                        </div>

                        <!-- RIGHT: ACTIONS -->
                        <div class="flex items-center gap-3">
                            <a href="index.html"
                                class="group flex items-center gap-1.5 text-slate-500 hover:text-slate-800 transition px-3 py-1.5 rounded-md hover:bg-slate-50">
                                <svg class="w-4 h-4 text-slate-400 group-hover:text-slate-600" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                                <span class="text-xs font-semibold">Ver P√∫blico</span>
                            </a>
                            <div class="h-6 w-px bg-slate-200 mx-1"></div>
                            <button onclick="location.reload()"
                                class="bg-red-50 hover:bg-red-100 text-red-600 text-xs font-bold py-2 px-4 rounded shadow-sm hover:shadow flex items-center gap-2 transition transform active:scale-95">
                                <span>üö™</span> SALIR
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <main class="max-w-7xl mx-auto p-4">
                <!-- Status -->
                <div id="statusBox"
                    class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 flex items-center justify-between">
                    <span id="statusText" class="text-yellow-700 font-bold">‚è≥ Conectando con Base de Datos...</span>
                </div>

                <!-- Tabs (Unified Design) -->
                <div
                    class="bg-white border-b border-gray-200 px-4 py-3 flex items-center gap-3 overflow-x-auto shadow-sm mb-6 rounded-lg whitespace-nowrap">
                    <button onclick="setTab('General')" id="btnGeneral"
                        class="tab-btn px-4 py-1.5 rounded-md font-bold text-sm border border-transparent hover:bg-gray-50 text-gray-600 transition h-9 flex items-center gap-2">üåç
                        General</button>
                    <button onclick="setTab('Guadiana')" id="btnGuadiana"
                        class="tab-btn px-4 py-1.5 rounded-md font-bold text-sm border border-transparent hover:bg-gray-50 text-gray-600 transition h-9 flex items-center gap-2">üè®
                        Guadiana</button>
                    <button onclick="setTab('Cumbria')" id="btnCumbria"
                        class="tab-btn px-4 py-1.5 rounded-md font-bold text-sm border border-transparent hover:bg-gray-50 text-gray-600 transition h-9 flex items-center gap-2">üè®
                        Cumbria</button>
                    <button onclick="setTab('Montajes')" id="btnMontajes"
                        class="tab-btn px-4 py-1.5 rounded-md font-bold text-sm border border-transparent hover:bg-gray-50 text-gray-600 transition h-9 flex items-center gap-2">ü™ë
                        Montajes</button>
                    <button onclick="setTab('Extras')" id="btnExtras"
                        class="tab-btn px-4 py-1.5 rounded-md font-bold text-sm border border-transparent hover:bg-gray-50 text-gray-600 transition h-9 flex items-center gap-2">üìΩÔ∏è
                        Extras</button>
                    <button onclick="setTab('Festivos')" id="btnFestivos"
                        class="tab-btn px-4 py-1.5 rounded-md font-bold text-sm border border-transparent hover:bg-gray-50 text-gray-600 transition h-9 flex items-center gap-2">üìÖ
                        Festivos</button>
                    <button onclick="setTab('Bloqueos')" id="btnBloqueos"
                        class="tab-btn px-4 py-1.5 rounded-md font-bold text-sm border border-transparent hover:bg-gray-50 text-gray-600 transition h-9 flex items-center gap-2">üö´
                        Bloqueos</button>
                </div>

                <!-- Config Area -->
                <div id="editorContent"></div>
            </main>

            <!-- Save FAB -->
            <div class="fixed bottom-8 right-8 z-50">
                <button onclick="saveAll()" id="btnSave"
                    class="bg-gray-900 text-white px-8 py-4 rounded-full shadow-2xl font-bold text-lg hover:bg-black transition transform hover:scale-105 flex items-center gap-2">
                    <span>üíæ</span> GUARDAR CAMBIOS
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- 1. LOGIN ---
        function checkPass() {
            var val = document.getElementById("passInput").value.trim().toLowerCase();
            if (val === "mesachef2026") {
                document.getElementById("btnLogin").style.background = "#10b981";
                document.getElementById("btnLogin").innerText = "ACCEDIENDO...";
                setTimeout(() => {
                    document.getElementById("loginScreen").classList.add("hidden");
                    document.getElementById("dashboard").classList.remove("hidden");
                    loadFirebase();
                }, 500);
            } else {
                document.getElementById("errorMsg").style.display = "block";
            }
        }

        // --- 2. FIREBASE & DATA ---
        var db;
        var fullConfig = { Guadiana: [], Cumbria: [], montajes: [], horarios: {}, aiOptions: {}, textoLegal: "", mantenimiento: false };
        var currentTab = "General";

        function loadFirebase() {
            // Check if already loaded
            if (window.firebase && window.firebase.apps && window.firebase.apps.length && window.firebase.auth) {
                initApp();
                return;
            }

            // Load Dynamically if not present
            var s1 = document.createElement("script");
            s1.src = "https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js";
            s1.onload = function () {
                var s2 = document.createElement("script");
                s2.src = "https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js";
                s2.onload = function () {
                    var s3 = document.createElement("script");
                    s3.src = "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js";
                    s3.onload = initApp;
                    s3.onerror = function () { alert("Error loading Firestore"); };
                    document.head.appendChild(s3);
                };
                s2.onerror = function () { alert("Error loading Auth"); };
                document.head.appendChild(s2);
            };
            s1.onerror = function () { alert("Error loading Firebase App"); };
            document.head.appendChild(s1);
        }

        function initApp() {
            try {
                // ** CREDENTIALS (Mesa Chef Prod) **
                const firebaseConfig = {
                    apiKey: "AIzaSyAXv_wKD48EFDe8FBQ-6m0XGUNoxSRiTJY",
                    authDomain: "mesa-chef-prod.firebaseapp.com",
                    projectId: "mesa-chef-prod",
                    storageBucket: "mesa-chef-prod.firebasestorage.app",
                    messagingSenderId: "43170330072",
                    appId: "1:43170330072:web:bcdd09e39930ad08bf2ead"
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }

                // AUTHENTICATE
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        startDB();
                    } else {
                        firebase.auth().signInAnonymously().then(() => {
                            // Auth success, onAuthStateChanged will trigger again
                        }).catch((error) => {
                            document.getElementById("statusText").innerText = "Error Auth: " + error.message;
                        });
                    }
                });

            } catch (e) {
                if (e.code === 'app/duplicate-app') {
                    firebase.auth().onAuthStateChanged((user) => {
                        if (user) startDB();
                        else firebase.auth().signInAnonymously();
                    });
                } else {
                    alert("Error Config: " + e.message);
                }
            }
        }

        function startDB() {
            db = firebase.firestore();
            loadData();
        }

        function loadData() {
            document.getElementById("statusText").innerText = "‚è≥ Cargando configuraci√≥n...";

            db.collection("master_data").doc("CONFIG_SALONES").get().then(doc => {
                if (doc.exists) {
                    fullConfig = doc.data();
                }

                // --- ROBUST DEFAULT SEEDING ---
                // If either Hotel is missing/empty, we should provider our reference data
                const needsSeeding = !fullConfig.Guadiana || fullConfig.Guadiana.length === 0 || !fullConfig.Cumbria || fullConfig.Cumbria.length === 0;

                if (needsSeeding) {
                    console.log("Seeding Default Salon Data...");
                    fullConfig.Guadiana = [
                        { name: "Puerta de Alarcos", pax: 800, m2: 570, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 600, escuela: 500, coctel: 800, teatro: 800 } },
                        { name: "Puerta de Calatrava", pax: 135, m2: 125, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 100, escuela: 100, imperial: 40, coctel: 130, teatro: 135, forma_u: 50 } },
                        { name: "Puerta del Carmen", pax: 120, m2: 110, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 90, escuela: 90, imperial: 40, coctel: 100, teatro: 120, forma_u: 50 } },
                        { name: "Puerta de Ciruela", pax: 20, m2: 25, priceHalf: 0, priceFull: 0, active: true, capacities: { imperial: 10, teatro: 20 } },
                        { name: "Puerta de Granada", pax: 135, m2: 120, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 100, escuela: 100, imperial: 40, coctel: 130, teatro: 135, forma_u: 50 } },
                        { name: "Puerta de Santa Mar√≠a", pax: 80, m2: 70, priceHalf: 0, priceFull: 0, active: true, capacities: { escuela: 60, imperial: 30, coctel: 60, teatro: 80, forma_u: 30 } },
                        { name: "Puerta de Toledo", pax: 160, m2: 150, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 120, escuela: 130, imperial: 50, coctel: 150, teatro: 160, forma_u: 60 } }
                    ];
                    fullConfig.Cumbria = [
                        { name: "Sal√≥n Mercurio", pax: 90, m2: 77, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 70, teatro: 90, imperial: 32, escuela: 40, coctel: 70, forma_u: 30 } },
                        { name: "Sal√≥n Venus", pax: 90, m2: 77, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 70, teatro: 90, imperial: 32, escuela: 40, coctel: 70, forma_u: 30 } },
                        { name: "Sal√≥n La Tierra", pax: 70, m2: 68, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 50, teatro: 70, imperial: 26, escuela: 30, coctel: 60, forma_u: 24 } },
                        { name: "Sal√≥n Marte", pax: 90, m2: 77, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 70, teatro: 90, imperial: 32, escuela: 40, coctel: 70, forma_u: 30 } },
                        { name: "Sal√≥n J√∫piter", pax: 70, m2: 68, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 50, teatro: 70, imperial: 26, escuela: 30, coctel: 60, forma_u: 24 } }
                    ];
                    // Also seed options if missing
                    if (!fullConfig.horarios) fullConfig.horarios = { almIni: "13:00", almFin: "16:00", cenaIni: "20:30", cenaFin: "23:00", corte: "18:00" };
                    if (!fullConfig.aiOptions) fullConfig.aiOptions = { tone: "formal", prompt: "" };

                    // Trigger Save
                    saveAll();
                }

                // Default Montajes (Always Ensure)
                if (!fullConfig.montajes || fullConfig.montajes.length === 0) {
                    fullConfig.montajes = ["Banquete", "Escuela", "Teatro", "C√≥ctel", "U", "Imperial"];
                }
                // Default Montajes
                if (!fullConfig.montajes || fullConfig.montajes.length === 0) {
                    fullConfig.montajes = ["Banquete", "Escuela", "Teatro", "C√≥ctel", "U", "Imperial"];
                }

                document.getElementById("statusText").innerText = "‚úÖ Datos cargados correctamente";
                document.getElementById("statusText").className = "text-green-700 font-bold";
                document.getElementById("statusBox").className = "bg-green-50 border-l-4 border-green-500 p-4 mb-6 flex items-center justify-between";

                // DETECT EMPTY DB for User Convenience
                if (fullConfig.Guadiana.length === 0 && fullConfig.Cumbria.length === 0) {
                    document.getElementById("statusBox").innerHTML = `
                        <div class="flex items-center gap-2">
                           <span class="text-xl">‚ö†Ô∏è</span>
                           <div>
                              <span class="text-yellow-700 font-bold">Base de Datos sin Salones</span>
                              <div class="text-xs text-yellow-600">No se encontraron salones. ¬øQuieres cargar los de ejemplo?</div>
                           </div>
                        </div>
                        <button onclick="restoreDefaults()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded shadow">
                            RESTAURAR DATOS
                        </button>
                     `;
                }

                setTab('General');
            }).catch(e => {
                // alert("Error DB: " + e.message);
                document.getElementById("statusText").innerText = "Error: " + e.message;
            });
        }

        window.restoreDefaults = function () {
            if (!confirm("‚ö†Ô∏è ¬øEst√°s seguro? Se borrar√° la configuraci√≥n actual y se pondr√°n los datos por defecto.")) return;

            fullConfig.horarios = { almIni: "13:00", almFin: "16:00", cenaIni: "20:30", cenaFin: "23:00", corte: "18:00" };
            fullConfig.montajes = ["Banquete", "Escuela", "Teatro", "C√≥ctel", "U", "Imperial"];
            fullConfig.extras = [];
            fullConfig.festivos = [];
            fullConfig.bloqueos = [];

            fullConfig.Guadiana = [
                { name: "Puerta de Alarcos", pax: 800, m2: 570, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 600, escuela: 500, coctel: 800, teatro: 800 } },
                { name: "Puerta de Calatrava", pax: 135, m2: 125, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 100, escuela: 100, imperial: 40, coctel: 130, teatro: 135, forma_u: 50 } },
                { name: "Puerta del Carmen", pax: 120, m2: 110, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 90, escuela: 90, imperial: 40, coctel: 100, teatro: 120, forma_u: 50 } },
                { name: "Puerta de Ciruela", pax: 20, m2: 25, priceHalf: 0, priceFull: 0, active: true, capacities: { imperial: 10, teatro: 20 } },
                { name: "Puerta de Granada", pax: 135, m2: 120, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 100, escuela: 100, imperial: 40, coctel: 130, teatro: 135, forma_u: 50 } },
                { name: "Puerta de Santa Mar√≠a", pax: 80, m2: 70, priceHalf: 0, priceFull: 0, active: true, capacities: { escuela: 60, imperial: 30, coctel: 60, teatro: 80, forma_u: 30 } },
                { name: "Puerta de Toledo", pax: 160, m2: 150, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 120, escuela: 130, imperial: 50, coctel: 150, teatro: 160, forma_u: 60 } }
            ];

            fullConfig.Cumbria = [
                { name: "Sal√≥n Mercurio", pax: 90, m2: 77, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 70, teatro: 90, imperial: 32, escuela: 40, coctel: 70, forma_u: 30 } },
                { name: "Sal√≥n Venus", pax: 90, m2: 77, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 70, teatro: 90, imperial: 32, escuela: 40, coctel: 70, forma_u: 30 } },
                { name: "Sal√≥n La Tierra", pax: 70, m2: 68, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 50, teatro: 70, imperial: 26, escuela: 30, coctel: 60, forma_u: 24 } },
                { name: "Sal√≥n Marte", pax: 90, m2: 77, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 70, teatro: 90, imperial: 32, escuela: 40, coctel: 70, forma_u: 30 } },
                { name: "Sal√≥n J√∫piter", pax: 70, m2: 68, priceHalf: 0, priceFull: 0, active: true, capacities: { banquete: 50, teatro: 70, imperial: 26, escuela: 30, coctel: 60, forma_u: 24 } }
            ];
            fullConfig.aiOptions = { tone: "formal", prompt: "" };

            // Re-render and Save
            render();
            markDirty();
            saveAll();
        };

        // --- 3. UI RENDER ---
        function setTab(t) {
            currentTab = t;
            // Tabs visual
            document.querySelectorAll(".tab-btn").forEach(b => b.className = "tab-btn px-4 py-1.5 rounded-md font-bold text-sm border border-transparent hover:bg-gray-50 text-gray-600 transition h-9 flex items-center gap-2 cursor-pointer");
            var btn = document.getElementById("btn" + t);
            if (btn) btn.className = "tab-btn px-4 py-1.5 rounded-md font-bold text-sm border border-blue-200 bg-blue-50 text-blue-700 transition h-9 flex items-center gap-2 shadow-sm cursor-default";

            render();
        }

        function render() {
            var c = document.getElementById("editorContent");
            c.innerHTML = "";
            if (currentTab === 'General') renderGeneral(c);
            else if (currentTab === 'Montajes') renderMontajes(c);
            else if (currentTab === 'Extras') renderExtras(c);
            else if (currentTab === 'Festivos') renderFestivos(c);
            else if (currentTab === 'Bloqueos') renderBloqueos(c);
            else renderSalones(c, currentTab);
        }

        function renderGeneral(c) {
            c.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card">
                        <h3>‚è±Ô∏è Horarios</h3>
                        <div class="grid-2">
                           <div><label>Apertura Almuerzo</label><input type="time" value="${fullConfig.horarios.almIni || '13:00'}" onchange="updCfg('horarios','almIni',this.value)"></div>
                           <div><label>Cierre Almuerzo</label><input type="time" value="${fullConfig.horarios.almFin || '16:00'}" onchange="updCfg('horarios','almFin',this.value)"></div>
                        </div>
                        <div class="grid-2">
                           <div><label>Apertura Cena</label><input type="time" value="${fullConfig.horarios.cenaIni || '20:30'}" onchange="updCfg('horarios','cenaIni',this.value)"></div>
                           <div><label>Cierre Cena</label><input type="time" value="${fullConfig.horarios.cenaFin || '23:00'}" onchange="updCfg('horarios','cenaFin',this.value)"></div>
                        </div>
                        <label>Corte Horario (Tarde)</label>
                        <input type="time" value="${fullConfig.horarios.corte || '18:00'}" onchange="updCfg('horarios','corte',this.value)">
                    </div>
                    
                    <div class="card">
                        <h3>ü§ñ IA & Opciones</h3>
                        <label>Tono</label>
                        <select onchange="updCfg('aiOptions','tone',this.value)">
                            <option value="formal" ${fullConfig.aiOptions.tone === 'formal' ? 'selected' : ''}>Formal</option>
                            <option value="cercano" ${fullConfig.aiOptions.tone === 'cercano' ? 'selected' : ''}>Cercano</option>
                            <option value="lujo" ${fullConfig.aiOptions.tone === 'lujo' ? 'selected' : ''}>Lujo</option>
                        </select>
                        <label>Prompt Extra</label>
                        <textarea rows="3" onchange="updCfg('aiOptions','prompt',this.value)">${fullConfig.aiOptions.prompt || ''}</textarea>
                    </div>

                    <div class="card border border-red-200 bg-red-50">
                        <h3 class="text-red-700">üîí Mantenimiento</h3>
                        <label class="flex items-center gap-2 mt-4 text-red-700 cursor-pointer">
                            <input type="checkbox" ${fullConfig.mantenimiento ? 'checked' : ''} onchange="fullConfig.mantenimiento=this.checked; markDirty()" style="width:auto;">
                            ACTIVAR MODO MANTENIMIENTO
                        </label>
                    </div>

                    <div class="card md:col-span-2">
                        <h3>üìÑ Texto Legal (Pie PDF)</h3>
                        <textarea rows="4" onchange="fullConfig.textoLegal=this.value; markDirty()" class="font-mono text-sm">${fullConfig.textoLegal || ''}</textarea>
                    </div>
                </div>
            `;
        }

        function renderSalones(c, hotel) {
            var list = fullConfig[hotel] || [];
            var html = `<div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="border-0 mb-0">Salones: ${hotel}</h3>
                    <button onclick="addItem()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">+ A√±adir</button>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left font-sm">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                    <tr>
                        <th class="p-2">Nombre</th>
                        <th class="p-2 w-20">Pax</th>
                        <th class="p-2 w-20">M2</th>
                        <th class="p-2 w-20">‚Ç¨ 1/2</th>
                        <th class="p-2 w-20">‚Ç¨ Comp</th>
                        <th class="p-2 w-10 text-center">ON</th>
                        <th class="w-10"></th>
                        <th class="w-10"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">`;

            list.forEach((s, i) => {
                html += `<tr class="hover:bg-blue-50">
                    <td class="p-2"><input value="${s.name}" onchange="updS(${i},'name',this.value)" class="w-full bg-transparent outline-none font-bold text-slate-700"></td>
                    <td class="p-2"><input type="number" value="${s.pax || 0}" onchange="updS(${i},'pax',this.value)" class="w-full bg-transparent outline-none text-center"></td>
                    <td class="p-2"><input type="number" value="${s.m2 || 0}" onchange="updS(${i},'m2',this.value)" class="w-full bg-transparent outline-none text-center"></td>
                    <td class="p-2"><input type="number" value="${s.priceHalf || 0}" onchange="updS(${i},'priceHalf',this.value)" class="w-full bg-transparent outline-none text-right"></td>
                    <td class="p-2"><input type="number" value="${s.priceFull || 0}" onchange="updS(${i},'priceFull',this.value)" class="w-full bg-transparent outline-none text-right"></td>
                    <td class="p-2 text-center"><input type="checkbox" ${s.active !== false ? 'checked' : ''} onchange="updS(${i},'active',this.checked)" style="width:auto;"></td>
                    <td class="p-2 text-center"><button onclick="openCapacities(${i},'${hotel}')" class="text-blue-500 hover:text-blue-700" title="Configurar Capacidades">‚öôÔ∏è</button></td>
                    <td class="p-2"><button onclick="delItem(${i})" class="text-gray-400 hover:text-red-500 font-bold">&times;</button></td>
                </tr>`;
            });
            html += `</tbody></table></div></div>`;
            c.innerHTML = html;
        }

        function renderMontajes(c) {
            var html = `<div class="card"><div class="flex gap-4 mb-4"><input id="newM_val" placeholder="Nuevo..." class="flex-1"><button onclick="addItem()" class="bg-blue-600 text-white px-4 rounded font-bold">A√±adir</button></div><div class="flex flex-wrap gap-2">`;
            (fullConfig.montajes || []).forEach((m, i) => {
                html += `<div class="bg-blue-50 text-blue-800 px-3 py-1 rounded-full flex gap-2 items-center border border-blue-100"><span contenteditable onblur="updM(${i},this.innerText)">${m}</span><button onclick="delItem(${i})" class="text-red-400 font-bold">&times;</button></div>`;
            });
            html += `</div></div>`;
            c.innerHTML = html;
        }

        function renderExtras(c) {
            var list = fullConfig.extras || [];
            var html = `<div class="card"><div class="flex justify-between items-center mb-4"><h3>üìΩÔ∏è Extras y Servicios</h3><button onclick="addItem()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">+ A√±adir</button></div>
            <div class="overflow-x-auto"><table class="w-full text-left font-sm"><thead class="bg-gray-50 text-gray-500 uppercase text-xs"><tr><th class="p-2">Concepto</th><th class="p-2 w-24">Precio (‚Ç¨)</th><th class="p-2 w-32">Categor√≠a</th><th class="w-10"></th></tr></thead><tbody class="divide-y divide-gray-100">`;
            list.forEach((e, i) => {
                html += `<tr>
                    <td class="p-2"><input value="${e.name}" onchange="updArr('extras',${i},'name',this.value)" class="w-full bg-transparent outline-none font-bold"></td>
                    <td class="p-2"><input type="number" value="${e.price || 0}" onchange="updArr('extras',${i},'price',this.value)" class="w-full bg-transparent outline-none"></td>
                    <td class="p-2"><input value="${e.type || ''}" placeholder="Ej: AV" onchange="updArr('extras',${i},'type',this.value)" class="w-full bg-transparent outline-none text-gray-400"></td>
                    <td class="p-2"><button onclick="delItem(${i})" class="text-red-400 font-bold">&times;</button></td></tr>`;
            });
            html += `</tbody></table></div></div>`;
            c.innerHTML = html;
        }

        function renderFestivos(c) {
            var list = fullConfig.festivos || [];
            var html = `<div class="card"><div class="flex justify-between items-center mb-4"><h3>üìÖ D√≠as Bloqueados (Festivos)</h3><button onclick="addItem()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">+ A√±adir</button></div>
            <div class="overflow-x-auto"><table class="w-full text-left font-sm"><thead class="bg-gray-50 text-gray-500 uppercase text-xs"><tr><th class="p-2 w-40">Fecha</th><th class="p-2">Motivo</th><th class="w-10"></th></tr></thead><tbody class="divide-y divide-gray-100">`;
            list.forEach((f, i) => {
                html += `<tr>
                    <td class="p-2"><input type="date" value="${f.date}" onchange="updArr('festivos',${i},'date',this.value)" class="w-full bg-transparent outline-none"></td>
                    <td class="p-2"><input value="${f.name || ''}" placeholder="Ej: Navidad" onchange="updArr('festivos',${i},'name',this.value)" class="w-full bg-transparent outline-none"></td>
                    <td class="p-2"><button onclick="delItem(${i})" class="text-red-400 font-bold">&times;</button></td></tr>`;
            });
            html += `</tbody></table></div></div>`;
            c.innerHTML = html;
        }

        function renderBloqueos(c) {
            var list = fullConfig.bloqueos || [];

            // Build Salon List for Select
            var salonOptions = `<option value="TODOS">TODOS LOS SALONES</option>`;
            (fullConfig.Guadiana || []).forEach(s => salonOptions += `<option value="${s.name}">${s.name} (G)</option>`);
            (fullConfig.Cumbria || []).forEach(s => salonOptions += `<option value="${s.name}">${s.name} (C)</option>`);

            var html = `<div class="card"><div class="flex justify-between items-center mb-4"><h3>üö´ Bloqueos de Fecha</h3><button onclick="addItem()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">+ A√±adir</button></div>
            <div class="overflow-x-auto"><table class="w-full text-left font-sm"><thead class="bg-gray-50 text-gray-500 uppercase text-xs"><tr><th class="p-2 w-48">Sal√≥n</th><th class="p-2 w-32">Desde</th><th class="p-2 w-32">Hasta</th><th class="p-2">Motivo</th><th class="w-10"></th></tr></thead><tbody class="divide-y divide-gray-100">`;

            list.forEach((b, i) => {
                html += `<tr>
                    <td class="p-2">
                        <select onchange="updArr('bloqueos',${i},'salon',this.value)" class="w-full bg-transparent outline-none border border-gray-200 rounded p-1 text-sm">
                            ${salonOptions.replace(`value="${b.salon}"`, `value="${b.salon}" selected`)}
                        </select>
                    </td>
                    <td class="p-2"><input type="date" value="${b.start}" onchange="updArr('bloqueos',${i},'start',this.value)" class="w-full bg-transparent outline-none"></td>
                    <td class="p-2"><input type="date" value="${b.end}" onchange="updArr('bloqueos',${i},'end',this.value)" class="w-full bg-transparent outline-none"></td>
                    <td class="p-2"><input value="${b.note || ''}" placeholder="Ej: Mantenimiento" onchange="updArr('bloqueos',${i},'note',this.value)" class="w-full bg-transparent outline-none"></td>
                    <td class="p-2"><button onclick="delItem(${i})" class="text-red-400 font-bold">&times;</button></td>
                </tr>`;
            });
            html += `</tbody></table></div></div>`;
            c.innerHTML = html;
        }

        // --- UPDATERS ---
        function updCfg(cat, k, v) { if (!fullConfig[cat]) fullConfig[cat] = {}; fullConfig[cat][k] = v; markDirty(); }
        function updS(i, k, v) { if (k !== 'name' && k !== 'active') v = parseFloat(v); fullConfig[currentTab][i][k] = v; markDirty(); }
        function updM(i, v) { fullConfig.montajes[i] = v; markDirty(); }
        function updArr(listName, i, k, v) { fullConfig[listName][i][k] = v; markDirty(); }

        window.addItem = () => {
            if (currentTab === 'Montajes') { var v = document.getElementById("newM_val").value; if (v) { fullConfig.montajes.push(v); render(); markDirty(); } }
            else if (currentTab === 'Extras') { if (!fullConfig.extras) fullConfig.extras = []; fullConfig.extras.push({ name: "Nuevo Extra", price: 0, type: "General" }); render(); markDirty(); }
            else if (currentTab === 'Festivos') { if (!fullConfig.festivos) fullConfig.festivos = []; fullConfig.festivos.push({ date: new Date().toISOString().split('T')[0], name: "Festivo" }); render(); markDirty(); }
            else if (currentTab === 'Bloqueos') { if (!fullConfig.bloqueos) fullConfig.bloqueos = []; var today = new Date().toISOString().split('T')[0]; fullConfig.bloqueos.push({ salon: "TODOS", start: today, end: today, note: "Nuevo Bloqueo" }); render(); markDirty(); }
            else if (currentTab !== 'General') { fullConfig[currentTab].push({ name: "Nuevo", pax: 0, m2: 0, active: true, capacities: {} }); render(); markDirty(); }
        }
        window.delItem = (i) => {
            if (confirm("¬øBorrar?")) {
                if (currentTab === 'Montajes') fullConfig.montajes.splice(i, 1);
                else if (currentTab === 'Extras') fullConfig.extras.splice(i, 1);
                else if (currentTab === 'Festivos') fullConfig.festivos.splice(i, 1);
                else if (currentTab === 'Bloqueos') fullConfig.bloqueos.splice(i, 1);
                else fullConfig[currentTab].splice(i, 1);
                render(); markDirty();
            }
        }

        function markDirty() {
            var b = document.getElementById("btnSave");
            b.innerText = "üíæ GUARDAR*";
            b.classList.replace("bg-gray-900", "bg-blue-600");
        }

        window.saveAll = async () => {
            var b = document.getElementById("btnSave");
            b.innerText = "GUARDANDO...";
            try {
                await db.collection("master_data").doc("CONFIG_SALONES").set(fullConfig);
                b.innerText = "¬°GUARDADO!";
                b.classList.replace("bg-blue-600", "bg-green-500");
                setTimeout(() => { b.innerText = "üíæ GUARDAR CAMBIOS"; b.classList.replace("bg-green-500", "bg-gray-900"); }, 2000);
            } catch (e) { alert(e.message); }
        }
        // --- MODAL CAPACITIES ---
        let currentCapIndex = -1;
        let currentCapHotel = "";

        window.openCapacities = (i, hotel) => {
            currentCapIndex = i;
            currentCapHotel = hotel;
            var s = fullConfig[hotel][i];
            var caps = s.capacities || {};

            document.getElementById("capTitle").innerText = "Capacidades: " + s.name;
            document.getElementById("capBanquete").value = caps.banquete || 0;
            document.getElementById("capEscuela").value = caps.escuela || 0;
            document.getElementById("capTeatro").value = caps.teatro || 0;
            document.getElementById("capCoctel").value = caps.coctel || 0;
            document.getElementById("capImperial").value = caps.imperial || 0;
            document.getElementById("capU").value = caps.forma_u || 0;

            document.getElementById("capModal").classList.remove("hidden");
        }

        window.closeCapacities = () => {
            document.getElementById("capModal").classList.add("hidden");
        }

        window.saveCapacities = () => {
            var caps = {
                banquete: parseInt(document.getElementById("capBanquete").value) || 0,
                escuela: parseInt(document.getElementById("capEscuela").value) || 0,
                teatro: parseInt(document.getElementById("capTeatro").value) || 0,
                coctel: parseInt(document.getElementById("capCoctel").value) || 0,
                imperial: parseInt(document.getElementById("capImperial").value) || 0,
                forma_u: parseInt(document.getElementById("capU").value) || 0
            };
            fullConfig[currentCapHotel][currentCapIndex].capacities = caps;
            markDirty();
            closeCapacities();
        }

    </script>

    <!-- MODAL -->
    <div id="capModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-96 p-6">
            <h3 id="capTitle" class="text-xl font-bold mb-4">Capacidades</h3>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="text-xs font-bold text-gray-500">Banquete</label><input id="capBanquete"
                        type="number" class="w-full border rounded p-1"></div>
                <div><label class="text-xs font-bold text-gray-500">Escuela</label><input id="capEscuela" type="number"
                        class="w-full border rounded p-1"></div>
                <div><label class="text-xs font-bold text-gray-500">Teatro</label><input id="capTeatro" type="number"
                        class="w-full border rounded p-1"></div>
                <div><label class="text-xs font-bold text-gray-500">C√≥ctel</label><input id="capCoctel" type="number"
                        class="w-full border rounded p-1"></div>
                <div><label class="text-xs font-bold text-gray-500">Imperial</label><input id="capImperial"
                        type="number" class="w-full border rounded p-1"></div>
                <div><label class="text-xs font-bold text-gray-500">Forma U</label><input id="capU" type="number"
                        class="w-full border rounded p-1"></div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeCapacities()"
                    class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded">Cancelar</button>
                <button onclick="saveCapacities()"
                    class="px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700">Guardar</button>
            </div>
        </div>
    </div>
</body>

</html>