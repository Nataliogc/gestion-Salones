<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gestor de Eventos ‚Äì MesaChef</title>

    <link rel="icon" type="image/png" href="mesa-chef-192.png">
    <link rel="apple-touch-icon" href="mesa-chef-512.png">
    <meta name="theme-color" content="#263238">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root { --primary: #263238; --accent: #546e7a; --bg-body: #f0f2f5; --surface: #ffffff; --border: #dfe3e8; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background: var(--bg-body); color: #1a1a1a; font-size: 13px; }

        /* LANDING */
        #landingPage { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%); padding: 20px; }
        .landing-container { background: var(--surface); border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); padding: 40px; max-width: 900px; width: 100%; text-align: center; }
        .app-logo-big { width: 120px; height: 120px; object-fit: cover; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin-bottom: 10px; }
        .hotel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .h-card { border: 1px solid var(--border); border-radius: 20px; padding: 24px; cursor: pointer; transition: all 0.2s ease; background: #fff; display: flex; flex-direction: column; align-items: center; }
        .h-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.06); }
        .h-card img { max-height: 50px; margin-bottom: 15px; object-fit: contain; }
        .h-tag { background: #f3f4f6; color: #4b5563; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; }

        /* HEADER */
        #appContainer { display: none; min-height: 100vh; flex-direction: column; }
        .app-header { background: #fff; padding: 10px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap:15px; }
        .header-left { display: flex; align-items: center; gap: 14px; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .btn-back { width: 34px; height: 34px; border-radius: 50%; border: 1px solid #cfd8dc; background: #f5f5f5; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; }
        .header-title { font-size: 18px; font-weight: 700; color: var(--primary); margin: 0; }
        #headerLogo { max-height: 36px; object-fit: contain; }
        .connection-badge { display: inline-flex; align-items: center; gap: 6px; padding: 3px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; border: 1px solid transparent; white-space: nowrap; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-online { background: #e8f5e9; color: #1b5e20; border-color: #a5d6a7; } .status-online .status-dot { background: #2e7d32; }
        .status-offline { background: #ffebee; color: #c62828; border-color: #ef9a9a; } .status-offline .status-dot { background: #c62828; }

        .module-tabs { display: flex; gap: 6px; background: #f5f5f5; padding: 4px; border-radius: 999px; }
        .tab-btn { border: none; background: transparent; padding: 6px 14px; border-radius: 999px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; color: #37474f; }
        .tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }

        /* VISTAS */
        .controls-bar { padding: 15px 24px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
        .left-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .left-controls input, .left-controls select { margin: 0; width: auto; }
        .btn-nav { width: 30px; height: 30px; border: 1px solid #cbd5e1; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #475569; }
        .btn-nav:hover { background: #f1f5f9; }

        /* BUSCADOR IA STYLE */
        .search-wrapper { position: relative; display: flex; align-items: center; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; padding: 2px 4px; width: 300px; }
        .search-wrapper input { border: none; outline: none; padding: 6px 8px; font-size: 13px; width: 100%; border-radius: 6px; }
        .btn-search-ai { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 6px; padding: 4px 8px; font-size: 11px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 4px; white-space: nowrap; transition: 0.2s; }
        .btn-search-ai:hover { box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4); transform: translateY(-1px); }
        .search-loading { position: absolute; right: 80px; font-size: 12px; display: none; }

        .table-wrapper { margin: 0 20px 20px; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: auto; flex: 1; }
        
        table { border-collapse: collapse; width: 100%; }
        th { background: #f8fafc; padding: 12px; text-align: left; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 600; }
        td { border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        
        /* CELDAS FIN DE SEMANA (VIERNES, SABADO, DOMINGO) */
        .weekend-cell { background-color: #f1f5f9 !important; } 
        .salon-name-cell { background-color: #e2e8f0; color: #1e293b; font-weight: 800; text-align: center; vertical-align: middle; border-right: 1px solid #cbd5e1; width: 140px; min-width: 140px; }

        /* CALENDARIO SPLIT (SALONES) */
        .split-cell { display: flex; flex-direction: column; height: auto; min-height: 100px; width: 100%; position: relative; }
        .split-zone { flex: 1; border-bottom: 1px dotted #e2e8f0; display: flex; align-items: center; padding: 4px; cursor: pointer; transition: 0.1s; min-height: 50px; }
        .split-zone:hover { background: #e2e8f0; }
        
        .evt-full-day { position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; background: #dbeafe; color: #1e40af; border-left: 4px solid #2563eb; border-radius: 4px; padding: 4px 6px; font-size: 11px; z-index: 2; overflow: hidden; line-height: 1.3; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: center; gap: 2px; }
        .evt-part { width: 100%; height: 90%; border-radius: 4px; padding: 4px 6px; font-size: 10px; display: flex; flex-direction: column; justify-content: center; gap: 2px; overflow: hidden; line-height: 1.3; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        .evt-manana { background: #e0f2fe; color: #0369a1; border-left: 3px solid #0ea5e9; }
        .evt-tarde { background: #f3e8ff; color: #6b21a8; border-left: 3px solid #d8b4fe; }
        .evt-confirmado { background: #dcfce7 !important; color: #166534 !important; border-left-color: #22c55e !important; }
        .evt-pendiente { background: #ffedd5 !important; color: #9a3412 !important; border-left-color: #f97316 !important; opacity: 0.9; }
        .evt-gran { background: #fce7f3; color: #9d174d; border-left: 3px solid #be185d; }

        /* CALENDARIO RESTAURANTE */
        .cell-rest { padding: 4px; display:flex; flex-direction:column; gap:4px; }
        .rest-zone { min-height: 60px; border: 1px dashed #cbd5e1; border-radius: 8px; padding: 4px; }
        .mesa-card { display: block; background: #fff; padding: 4px 8px; margin-bottom: 4px; border-radius: 4px; font-size: 11px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .mesa-manana { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .mesa-tarde { background: #f3e8ff; color: #6b21a8; border: 1px solid #d8b4fe; }

        /* LISTADOS */
        .budget-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .budget-row { border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .budget-row:hover { background: #f8fafc; }
        .budget-row td { padding: 8px 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }

        .badge { display: inline-flex; padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: 600; text-transform: capitalize; }
        .st-confirmado { background: #dcfce7; color: #166534; border: 1px solid #22c55e; }
        .st-pendiente { background: #ffedd5; color: #9a3412; border: 1px solid #f97316; }
        .st-anulado { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .st-caducado { background: #f3f4f6; color: #64748b; border: 1px solid #94a3b8; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; justify-content: center; align-items: center; padding: 20px;}
        .modal-content { background: #fff; width: 100%; max-width: 900px; max-height: 90vh; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: #fff; border-bottom: 1px solid #eee; }
        .modal-body { padding: 20px; overflow-y: auto; background: #fff; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px; background: #f8fafc; }

        .ai-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #f5f3ff; border-radius: 8px; border: 1px dashed #8b5cf6; margin-bottom: 15px; }
        .btn-ai-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: #fff; padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; border:none; cursor:pointer; display: inline-flex; align-items: center; gap: 4px; box-shadow: 0 2px 4px rgba(139, 92, 246, 0.25); }

        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; display: flex; flex-direction: column; }
        label { font-size: 11px; text-transform: uppercase; color: #64748b; margin-bottom: 4px; font-weight: 600; }
        input, select, textarea { padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; width: 100%; }
        input:focus, select:focus { outline:none; border-color: #8b5cf6; }
        
        .svc-table { width: 100%; border-collapse: separate; border-spacing: 0 4px; margin-top: 5px; }
        .svc-table th { background: #f8fafc; padding: 8px; border-bottom: 2px solid #e2e8f0; text-align: left; color:#64748b; font-weight:700; font-size:11px; text-transform: uppercase; }
        .svc-table td { padding: 0 4px; vertical-align: middle; }
        
        .svc-input { width: 100%; border: 1px solid #e2e8f0; padding: 6px; border-radius: 6px; text-align: center; height: 34px; font-size: 13px; }
        .svc-input:focus { border-color: #8b5cf6; background: #f5f3ff; }
        .s-desc { text-align: left !important; }

        .btn-add-row { margin-top: 10px; background: #f0f9ff; border: 2px dashed #bae6fd; color: #0284c7; padding: 10px; border-radius: 8px; width: 100%; cursor:pointer; font-weight: 700; font-size: 13px; transition:0.2s; }
        .btn-add-row:hover { background: #e0f2fe; border-color: #7dd3fc; }

        .btn-primary { background: #0f172a; color: #fff; padding: 10px 20px; border-radius: 8px; font-weight: 600; border:none; cursor:pointer; }
        .btn-secondary { background: #fff; border: 1px solid #cbd5e1; color: #475569; padding: 10px 18px; border-radius: 8px; font-weight: 600; cursor:pointer; }
        .btn-confirm { background: #10b981; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; border:none; cursor:pointer; }
        .btn-anular { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; padding: 10px 18px; border-radius: 8px; font-weight: 600; cursor:pointer; }
        .btn-email { background: #8b5cf6; color: white; padding: 10px 18px; border-radius: 8px; font-weight: 600; border:none; cursor:pointer; display: flex; align-items: center; gap: 6px; }

        #aiResponseModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; justify-content: center; align-items: center; }
        .ai-box { background: white; padding: 20px; border-radius: 12px; width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div id="landingPage">
        <div class="landing-container">
            <img src="mesa-chef-512.png" class="app-logo-big" alt="Logo">
            <h1 style="margin:10px 0 5px; font-size:24px; color:#1f2937;">RESERVAS SALAS Y RESTAURANTE</h1>
            <p style="color:#666; margin-bottom:30px;">Gesti√≥n unificada para <strong>Sercotel Guadiana</strong> y <strong>Cumbria Spa&Hotel</strong>.</p>
            <div style="background:#d1fae5; color:#065f46; padding:4px 10px; border-radius:10px; display:inline-block; font-size:11px;">‚óè v25.31 FIXED CALENDAR & LOGIC</div>
            <div class="hotel-grid">
                <div class="h-card" onclick="initApp('Guadiana')">
                    <img src="Img/logo-guadiana.svg" alt="Logo Guadiana" onerror="this.style.display='none'">
                    <h3>Sercotel Guadiana</h3>
                    <div class="h-tag">üèõÔ∏è Ciudad Real ¬∑ Centro</div>
                </div>
                <div class="h-card" onclick="initApp('Cumbria')">
                    <img src="Img/logo-cumbria.svg" alt="Logo Cumbria" onerror="this.style.display='none'">
                    <h3>Cumbria Spa&Hotel</h3>
                    <div class="h-tag">üåÑ Ciudad Real ¬∑ Zona Norte</div>
                </div>
            </div>
        </div>
    </div>

    <div id="appContainer">
        <header class="app-header">
            <div class="header-left">
                <button class="btn-back" onclick="location.reload()">‚¨Ö</button>
                <h2 id="tituloHotelActual" class="header-title">Hotel</h2>
                <img id="headerLogo" style="height:30px; margin-left:10px;" />
                <div class="connection-badge status-offline" id="statusBadge">
                    <span class="status-dot"></span><span id="statusText">Conectando...</span>
                </div>
            </div>
            <div class="header-right">
                <div class="module-tabs">
                    <button class="tab-btn active" onclick="setModulo('eventos')" id="btnModEventos">üìÖ Salones</button>
                    <button class="tab-btn" onclick="setModulo('restaurante')" id="btnModRest">üç¥ Restaurante</button>
                    <button class="tab-btn" onclick="setModulo('presupuestos')" id="btnModPpto">üìÑ Presupuestos</button>
                    <button class="tab-btn" onclick="setModulo('grandes_eventos')" id="btnModGran">üéâ Grandes Eventos</button>
                </div>
                <a href="admin.html" class="btn-secondary" style="text-decoration:none; display:inline-flex; align-items:center; padding: 6px 12px; font-size: 12px;">‚öôÔ∏è Config</a>
            </div>
        </header>

        <div class="controls-bar">
            <div class="left-controls">
                <button class="btn-nav" onclick="cambiarSemana(-7)">‚ùÆ</button>
                <input type="date" id="fechaVista" onchange="render()" title="Fecha inicio vista" />
                <button class="btn-nav" onclick="cambiarSemana(7)">‚ùØ</button>
                <select id="filtroEstado" onchange="render()">
                    <option value="todos">Ver activos</option>
                    <option value="pendiente">‚è≥ Pendientes</option>
                    <option value="confirmado">‚úÖ Confirmados</option>
                    <option value="caducado">‚õî Caducados</option>
                    <option value="anulado">‚ùå Anulados</option>
                </select>
                <div class="search-wrapper">
                    <input type="text" id="searchInput" placeholder="üîé Buscar..." oninput="render()">
                    <span class="search-loading" id="aiLoading">Pensando...</span>
                    <button class="btn-search-ai" onclick="busquedaIA()">‚ú® IA</button>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" id="btnNuevoPrincipal" onclick="nuevoGeneral()">+ Nuevo</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table id="mainTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
            <div id="presupuestosContainer" style="display: none">
                <table class="budget-table">
                    <thead><tr><th style="width:100px">Fecha</th><th>Cliente</th><th style="width:140px">Sal√≥n</th><th style="width:100px">Estado</th><th style="width:80px;text-align:right">Total</th></tr></thead>
                    <tbody id="budgetBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalFicha">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Ficha</h3>
                <button onclick="document.getElementById('modalFicha').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer;">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="dataId"><input type="hidden" id="dataType"><input type="hidden" id="refPresupuesto">
                <div class="form-row" style="background:#f8fafc; padding:12px; border-radius:8px; border:1px solid #e2e8f0;">
                    <div class="form-group" id="grpFechaUnica"><label>Fecha</label><input type="date" id="inpFecha" /></div>
                    <div id="grpRangoFechas" style="display:none; gap:10px; flex:0 0 auto;">
                        <div style="width:130px;"><label>Desde</label><input type="date" id="inpFechaDesde" /></div>
                        <div style="width:130px;"><label>Hasta</label><input type="date" id="inpFechaHasta" /></div>
                    </div>
                    <div class="form-group" style="flex:1;">
                       <label>Espacio / Sal√≥n</label>
                       <select id="inpSalon" style="width:100%" onchange="checkSalonPendiente(this); actualizarLineaSalon()"></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex:2"><label>Cliente / Evento</label><input type="text" id="inpNombre" oninput="document.getElementById('modalTitle').innerText=this.value||'Ficha'" /></div>
                    <div class="form-group"><label>Tel√©fono</label><input type="text" id="inpTel" /></div>
                    <div class="form-group"><label>Email</label><input type="text" id="inpEmail" /></div>
                </div>
                <div class="form-row" id="blockRestaurante" style="display:none; background:#fffbeb; padding:6px; border-radius:8px; border:1px solid #fcd34d;">
                    <div style="display:flex; gap:10px; width:100%;">
                        <div class="form-group"><label>Hora</label><input type="time" id="inpHora" /></div>
                        <div class="form-group"><label>Pax</label><input type="number" id="inpPaxRest" /></div>
                        <div class="form-group"><label>Turno</label><select id="inpTurno"><option value="manana">‚òÄÔ∏è Almuerzo</option><option value="tarde">üåô Cena</option></select></div>
                    </div>
                </div>
                <div id="blockEventos">
                    <div class="form-row" style="align-items:flex-end; gap:10px;">
                        <div class="form-group" style="width:140px;"><label>Estado</label><select id="inpEstadoEvento"><option value="pendiente">‚è≥ Pendiente</option><option value="confirmado">‚úÖ Confirmado</option></select></div>
                        
                        <div class="form-group" style="width:140px;">
                            <label>Jornada</label>
                            <select id="inpTurnoEvento" onchange="actualizarLineaSalon()">
                                <option value="dia_completo">Jornada Comp.</option>
                                <option value="manana">1/2 D√≠a (Ma√±ana)</option>
                                <option value="tarde">1/2 D√≠a (Tarde)</option>
                            </select>
                        </div>

                        <div class="form-group" style="flex:1;"><label>Montaje</label><select id="inpMontaje"><option>Banquete</option><option>Escuela</option><option>Teatro</option><option>C√≥ctel</option><option>U</option></select></div>
                        <div class="form-group" style="width:80px;"><label>Pax A.</label><input type="number" id="inpPaxA" /></div>
                    </div>
                    <div style="margin-top:10px; border-top:1px solid #e2e8f0; padding-top:10px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <label style="color:var(--primary); font-weight:700;">DESGLOSE / SERVICIOS</label>
                            <button class="btn-ai-purple" onclick="generarMenuIA()">üü£ Men√∫ IA</button>
                        </div>
                        <table class="svc-table">
                            <thead><tr><th style="width:135px">Fecha</th><th>Concepto</th><th style="width:60px">Uds</th><th style="width:90px">Precio</th><th style="width:90px">Total</th><th style="width:30px"></th></tr></thead>
                            <tbody id="bodyServicios"></tbody>
                        </table>
                        <button class="btn-add-row" onclick="addServiceRow()">+ A√±adir l√≠nea</button>
                        <div style="text-align:right; font-size:15px; font-weight:700; margin-top:10px;">TOTAL: <span id="totalAmount">0.00</span> ‚Ç¨</div>
                    </div>
                </div>
                <div id="blockGran" style="display:none; background:#fdf2f8; padding:10px; border-radius:8px; border:1px solid #fbcfe8;">
                    <div class="form-row">
                        <div class="form-group"><label>Aforo</label><input type="number" id="inpAforo" oninput="calcGran()"></div>
                        <div class="form-group"><label>Precio Std</label><input type="number" id="inpPrcStd" onchange="aplicarStd()"></div>
                    </div>
                    <div style="font-weight:bold; margin-bottom:5px;">Pax: <span id="gPax">0</span> | Total: <span id="gTot">0</span>‚Ç¨ | Pendiente: <span id="gPend" style="color:red">0.00</span>‚Ç¨</div>
                    <table class="svc-table">
                        <thead><tr><th>Mesa</th><th>Nombre</th><th>Pax</th><th>Precio</th><th>Pagado</th><th></th></tr></thead>
                        <tbody id="bodyPart"></tbody>
                    </table>
                    <button class="btn-add-row" style="color:#be185d;" onclick="addPart()">+ A√±adir Participante</button>
                </div>
                <div class="form-row" style="margin-top:15px">
                    <div class="form-group"><label>Notas</label><textarea id="inpNotas" rows="2"></textarea></div>
                    <div class="form-group"><label>Nota Cliente (PDF)</label><textarea id="inpNotaCliente" rows="2"></textarea></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-email" id="btnEmail" onclick="redactarEmailIA()" style="display:none;">üìß Email</button>
                <button class="btn-secondary" id="btnPdf" onclick="imprimirPDF()">üìÑ PDF</button>
                <div style="flex:1"></div>
                <button class="btn-secondary" id="btnRecuperar" onclick="recuperarFicha()" style="display:none;">üîÑ Recuperar</button>
                <button class="btn-confirm" id="btnConfirmarPpto" onclick="confirmarPresupuesto()" style="display:none;">‚úÖ Confirmar</button>
                <button class="btn-anular" id="btnAnular" onclick="anularFicha()">Anular</button>
                <button class="btn-primary" id="btnGuardarMain" onclick="guardarFicha()">GUARDAR</button>
            </div>
        </div>
    </div>

    <div id="aiResponseModal"><div class="ai-box"><h3>ü§ñ Respuesta IA</h3><textarea id="aiOutput" style="width:100%; height:200px; padding:10px; border:1px solid #ccc;"></textarea><div style="text-align:right; margin-top:10px;"><button class="btn-secondary" onclick="document.getElementById('aiResponseModal').style.display='none'">Cerrar</button> <button class="btn-primary" onclick="copiarAI()">Copiar</button></div></div></div>

<script>
    const apiKey = "AIzaSyDnJMniLswGjpysPHiH3n3L6EpJyCkbS4E"; 
    const firebaseConfig = { apiKey: "AIzaSyBAK0sGUYpV8KHy1KwIdNRLtHlq5LT3Vwg", authDomain: "gestionsalones-bba4b.firebaseapp.com", projectId: "gestionsalones-bba4b", storageBucket: "gestionsalones-bba4b.firebasestorage.app", messagingSenderId: "860164285474", appId: "1:860164285474:web:ff995e88093e5aa5eb167b" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentHotel = null, currentModule = "eventos", dataCache = [], salonesConfig = {Guadiana:[], Cumbria:[], horarios:{}};
    let aiFilteredIds = null;

    function initApp(h) {
        currentHotel = h;
        document.getElementById("tituloHotelActual").innerText = h;
        document.getElementById("headerLogo").src = h==="Guadiana" ? "Img/logo-guadiana.svg" : "Img/logo-cumbria.svg";
        document.getElementById("landingPage").style.display = "none";
        document.getElementById("appContainer").style.display = "block";
        document.getElementById("fechaVista").valueAsDate = new Date();
        
        db.collection("master_data").doc("CONFIG_SALONES").onSnapshot(doc => { 
            if(doc.exists) salonesConfig = doc.data(); 
            render(); 
        });
        cargarDatos();
        setModulo('restaurante');
    }

    function cargarDatos() {
        db.collection("master_data").onSnapshot(snap => {
            document.getElementById("statusBadge").className = "connection-badge status-online";
            document.getElementById("statusText").innerText = "Conectado";
            dataCache = [];
            snap.forEach(d => { if(d.id!=="CONFIG_SALONES") dataCache.push({id:d.id, ...d.data()}); });
            render();
        }, (error) => {
            document.getElementById("statusBadge").className = "connection-badge status-offline";
            document.getElementById("statusText").innerText = "Sin Conexi√≥n";
        });
    }

    function setModulo(m) {
        currentModule = m;
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        if(m==="eventos") document.getElementById("btnModEventos").classList.add("active");
        if(m==="restaurante") document.getElementById("btnModRest").classList.add("active");
        if(m==="presupuestos") document.getElementById("btnModPpto").classList.add("active");
        if(m==="grandes_eventos") document.getElementById("btnModGran").classList.add("active");

        const isList = (m==="presupuestos" || m==="grandes_eventos");
        document.getElementById("mainTable").style.display = isList ? "none" : "table";
        document.getElementById("presupuestosContainer").style.display = isList ? "block" : "none";
        
        document.querySelectorAll(".btn-nav").forEach(btn => btn.style.display = (m==="presupuestos"?"none":"flex"));
        const btn = document.getElementById("btnNuevoPrincipal");
        if(m==="eventos") btn.innerText = "+ Nuevo Evento";
        if(m==="restaurante") btn.innerText = "+ Nueva Mesa";
        if(m==="presupuestos") btn.innerText = "+ Presupuesto";
        if(m==="grandes_eventos") btn.innerText = "+ Gran Evento";
        
        document.getElementById("searchInput").value = "";
        aiFilteredIds = null;
        render();
    }

    function render() {
        if(currentModule === "presupuestos" || currentModule === "grandes_eventos") {
            const body = document.getElementById("budgetBody");
            const isGran = currentModule === "grandes_eventos";
            body.innerHTML = "";
            const typeFilter = isGran ? "gran_evento" : "presupuesto";
            const filtro = document.getElementById("filtroEstado").value;
            const searchText = document.getElementById("searchInput").value.toLowerCase();
            const hoyStr = new Date().toISOString().split("T")[0];
            const isSearching = (aiFilteredIds !== null) || (searchText !== "");

            const items = dataCache.filter(d => {
                if(d.hotel !== currentHotel) return false;
                if (isSearching) {
                    if (aiFilteredIds !== null && !aiFilteredIds.includes(d.id)) return false;
                    if (searchText && !JSON.stringify(d).toLowerCase().includes(searchText)) return false;
                    return true;
                }
                if (d.fechaInicio < hoyStr) return false;
                if (d.type !== typeFilter) return false;
                
                let estadoReal = d.estado;
                if(d.type === 'presupuesto' && d.estado === 'pendiente' && d.validez && d.validez < hoyStr) estadoReal = 'caducado';

                if(filtro === "todos") return (estadoReal !== 'anulado' && estadoReal !== 'caducado');
                if(filtro === "anulado") return estadoReal === 'anulado';
                if(filtro === "caducado") return estadoReal === 'caducado';
                if(filtro === "pendiente") return estadoReal === 'pendiente'; 
                return estadoReal === filtro;
            });

            items.sort((a,b) => new Date(a.fechaInicio) - new Date(b.fechaInicio));

            items.forEach(d => {
                const tr = document.createElement("tr"); tr.className = "budget-row";
                let badgeClass = 'st-pendiente';
                if(d.estado === 'confirmado') badgeClass = 'st-confirmado';
                if(d.estado === 'anulado') badgeClass = 'st-anulado';
                
                const fechaFmt = formatearFechaListado(d.fechaInicio);
                tr.innerHTML = `<td>${fechaFmt}</td><td><b>${d.nombre}</b></td><td>${d.salon || 'Sin Sal√≥n'}</td><td><span class="badge ${badgeClass}">${d.estado}</span></td><td style="text-align:right; font-weight:bold;">${d.total || '-'}</td>`;
                tr.onclick = () => abrirModalId(d.id);
                body.appendChild(tr);
            });
            return;
        }

        const thead = document.getElementById("tableHead");
        const tbody = document.getElementById("tableBody");
        thead.innerHTML = ""; tbody.innerHTML = "";
        
        // --- FECHAS Y COLORES CORREGIDOS (Lunes 1 Dic) ---
        const fBase = new Date(document.getElementById("fechaVista").value);
        let hRow = `<tr><th style="width:150px;left:0;z-index:10;background:#fff;border-right:1px solid #e2e8f0;">ESPACIO</th>`;
        
        for(let i=0; i<7; i++) {
            const d = new Date(fBase); // Copia limpia para cada d√≠a
            d.setDate(d.getDate() + i);
            const diaSem = d.getDay(); // 0=Dom, 1=Lun ... 6=Sab
            // Viernes(5), S√°bado(6), Domingo(0) con color
            const esFinde = (diaSem === 5 || diaSem === 6 || diaSem === 0);
            const bg = esFinde ? 'background:#f1f5f9 !important;' : 'background:#fff;';
            const dateStr = d.toISOString().split("T")[0]; 
            hRow += `<th style="${bg}">${d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short', year: '2-digit' })}</th>`;
        }
        thead.innerHTML = hRow + "</tr>";

        const salones = (salonesConfig[currentHotel] || []).filter(s => s.active);
        salones.forEach(s => {
            const esRest = s.name.includes("Restaurante") || s.name.includes("Cafeter√≠a");
            if(currentModule === "restaurante" && !esRest) return;
            if(currentModule === "eventos" && esRest) return;

            const tr = document.createElement("tr");
            const sizeInfo = s.size ? `<br><span style="font-size:9px; color:#666;">${s.size} m¬≤</span>` : '';
            let row = `<td class="salon-name-cell" style="position:sticky;left:0;z-index:5">${s.name}${sizeInfo}</td>`;
            
            for(let i=0; i<7; i++) {
                const d = new Date(fBase); 
                d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split("T")[0];
                const diaSem = d.getDay();
                const esFinde = (diaSem === 5 || diaSem === 6 || diaSem === 0);
                const styleBg = esFinde ? 'style="background-color:#f1f5f9;"' : '';
                
                const evts = dataCache.filter(x => x.hotel===currentHotel && x.salon===s.name && x.fechaInicio<=dateStr && x.fechaFin>=dateStr && x.estado!=='anulado');
                
                let cellContent = "";
                
                // VISUALIZACI√ìN RESTAURADA (Separaci√≥n Restaurante vs Salones)
                if(currentModule === "restaurante") {
                    const m = evts.filter(x => x.turno === "manana").map(x=>`<div class="mesa-card mesa-manana" onclick="abrirModalId('${x.id}')"><b>${x.hora||''}</b> ${x.nombre} (${x.paxRest})</div>`).join('');
                    const t = evts.filter(x => x.turno === "tarde").map(x=>`<div class="mesa-card mesa-tarde" onclick="abrirModalId('${x.id}')"><b>${x.hora||''}</b> ${x.nombre} (${x.paxRest})</div>`).join('');
                    cellContent = `<div class="cell-rest"><div class="rest-zone">${m}</div><div class="rest-zone">${t}</div></div>`;
                } else {
                    const dia = evts.find(x => x.turno === "dia_completo");
                    if(dia) {
                        let cls = dia.type==='gran_evento'?'evt-gran':(dia.estado==='confirmado'?'evt-confirmado':'evt-full-day');
                        if(dia.type === 'presupuesto' && dia.estado === 'pendiente') cls = 'evt-pendiente'; 
                        cellContent = `<div class="split-cell" onclick="abrirModalId('${dia.id}')"><div class="${cls}"><b>${dia.nombre}</b></div></div>`;
                    } else {
                        const m = evts.find(x => x.turno === "manana");
                        const t = evts.find(x => x.turno === "tarde");
                        const renderPart = (e) => {
                            if(!e) return '';
                            let cls = e.turno==='manana'?'evt-manana':'evt-tarde';
                            if(e.estado==='confirmado') cls += ' evt-confirmado';
                            if(e.type === 'presupuesto' && e.estado === 'pendiente') cls += ' evt-pendiente';
                            return `<div class="evt-part ${cls}" onclick="event.stopPropagation(); abrirModalId('${e.id}')"><b>${e.nombre}</b></div>`;
                        };
                        cellContent = `<div class="split-cell"><div class="split-zone" onclick="nuevoSalon('${dateStr}','${s.name}','manana')">${renderPart(m)}</div><div class="split-zone" onclick="nuevoSalon('${dateStr}','${s.name}','tarde')">${renderPart(t)}</div></div>`;
                    }
                }
                row += `<td class="${esFinde?'weekend-cell':''}" ${styleBg}>${cellContent}</td>`;
            }
            tr.innerHTML = row;
            tbody.appendChild(tr);
        });
    }

    /* --- L√ìGICA DE FICHA --- */
    function nuevoGeneral() { nuevo(new Date().toISOString().split("T")[0], "", ""); }
    function nuevoSalon(f, s, t) { nuevo(f, s, t); }

    function nuevo(fecha, salon, turno) {
        document.getElementById("dataId").value = "";
        
        let type = "evento";
        if(currentModule==="restaurante") type="restaurante";
        if(currentModule==="presupuestos") type="presupuesto";
        if(currentModule==="grandes_eventos") type="gran_evento";
        document.getElementById("dataType").value = type;

        document.querySelectorAll("#modalFicha input").forEach(i => i.value="");
        document.querySelectorAll("#modalFicha select").forEach(i => i.selectedIndex=0);
        document.querySelectorAll("#modalFicha textarea").forEach(i => i.value="");
        
        document.getElementById("modalTitle").innerText = type==="presupuesto" ? "Nuevo Presupuesto" : "Nuevo Evento";
        document.getElementById("btnGuardarMain").innerText = "GUARDAR";

        document.getElementById("inpFecha").value = fecha;
        if(type==="presupuesto") { 
            document.getElementById("inpFechaDesde").value = fecha; 
            document.getElementById("inpFechaHasta").value = fecha; 
        }
        
        document.getElementById("blockRestaurante").style.display = type==="restaurante" ? "block" : "none";
        document.getElementById("blockEventos").style.display = (type==="evento"||type==="presupuesto") ? "block" : "none";
        document.getElementById("blockGran").style.display = type==="gran_evento" ? "block" : "none";
        document.getElementById("grpFechaUnica").style.display = type==="presupuesto" ? "none" : "block";
        document.getElementById("grpRangoFechas").style.display = type==="presupuesto" ? "flex" : "none";
        
        // FIX PDF: Mostrar siempre
        document.getElementById("btnPdf").style.display = "inline-flex"; 
        document.getElementById("btnConfirmarPpto").style.display = (type==="presupuesto") ? "inline-flex" : "none";

        document.getElementById("bodyServicios").innerHTML = "";
        document.getElementById("bodyPart").innerHTML = "";
        document.getElementById("totalAmount").innerText = "0.00";

        const sel = document.getElementById("inpSalon"); sel.innerHTML = "";
        const allS = salonesConfig[currentHotel] || [];
        if(type==="presupuesto") sel.innerHTML = "<option value='Pendiente'>-- Pendiente --</option>";
        
        allS.forEach(s => {
            if(!s.active) return;
            let infoExtra = "";
            if(s.pax > 0) infoExtra += `Max: ${s.pax}`;
            if(s.size > 0) infoExtra += (infoExtra ? " | " : "") + `${s.size} m¬≤`;
            if(infoExtra) infoExtra = ` (${infoExtra})`;
            const esRest = s.name.includes("Restaurante") || s.name.includes("Cafeter√≠a");
            if(type==="restaurante" && esRest) sel.innerHTML += `<option value="${s.name}">${s.name}${infoExtra}</option>`;
            if(type!=="restaurante" && !esRest) sel.innerHTML += `<option value="${s.name}">${s.name}${infoExtra}</option>`;
        });
        if(salon) sel.value = salon;

        if(type==="evento" && turno) document.getElementById("inpTurnoEvento").value = turno;
        if(type==="restaurante" && turno) document.getElementById("inpTurno").value = turno;
        if(type==="gran_evento") addPart(); 

        // FIX ROW: Crear fila siempre y forzar actualizaci√≥n
        if(type==="presupuesto" || type==="evento") { 
            addServiceRow({ date: fecha, desc: "Alquiler de Sal√≥n", price: "" });
            setTimeout(() => { actualizarLineaSalon(); }, 200); 
        }
        
        document.getElementById("btnRecuperar").style.display = "none";
        document.getElementById("btnAnular").style.display = "none"; 
        document.getElementById("modalFicha").style.display = "flex";
    }

    function addServiceRow(d={}) {
        const tr = document.createElement("tr");
        let defDate = document.getElementById("inpFecha").value;
        if(!d.date) {
            const existing = document.querySelectorAll(".s-date");
            if(existing.length>0) defDate = existing[existing.length-1].value;
        }
        const f = d.date || defDate;
        
        let displayPrice = "0.00 ‚Ç¨";
        if(d.price !== undefined && d.price !== "") {
             // Limpieza robusta si viene de la BD
             let s = String(d.price).replace(' ‚Ç¨', '').replace('‚Ç¨','').replace(/\s/g, '').replace(',', '.');
             let val = parseFloat(s) || 0;
             displayPrice = val.toFixed(2) + " ‚Ç¨";
        }

        tr.innerHTML = `
            <td><input type="date" class="svc-input s-date" value="${f}" onchange="updatePresupuestoDates()"></td>
            <td><input class="svc-input s-desc" value="${d.desc||''}" style="text-align:left" placeholder="Concepto"></td>
            <td><input type="number" class="svc-input s-uds" value="${d.uds||1}" oninput="calcTotal()"></td>
            <td><input type="text" class="svc-input s-price" value="${displayPrice}" placeholder="0.00 ‚Ç¨" onblur="formatPrice(this); calcTotal()" onfocus="this.select()"></td>
            <td><input class="svc-input s-tot" readonly style="font-weight:bold;"></td>
            <td style="color:red; cursor:pointer; text-align:center;" onclick="this.parentElement.remove(); calcTotal(); updatePresupuestoDates()">‚úï</td>`;
        
        document.getElementById("bodyServicios").appendChild(tr);
        calcTotal(); setTimeout(updatePresupuestoDates, 50); 
    }

    // --- L√ìGICA DE PRECIOS EXACTA (BASADA EN TU TXT) ---
    function actualizarLineaSalon() {
        const typeEl = document.getElementById("dataType");
        if(!typeEl || typeEl.value !== "presupuesto") return;
        const firstRow = document.querySelector("#bodyServicios tr");
        if(!firstRow) return;

        const salon = document.getElementById("inpSalon").value;
        const turno = document.getElementById("inpTurnoEvento").value;
        const inputDesc = firstRow.querySelector(".s-desc");
        const inputPrice = firstRow.querySelector(".s-price");
        if(!inputDesc || !inputPrice) return;

        if(!salon || salon === "Pendiente") {
            if(inputDesc.value.includes("Alquiler")) inputDesc.value = "Alquiler de Sal√≥n";
            return;
        }

        // TEXTO CORRECTO (1/2 D√≠a)
        let txtJornada = (turno === "dia_completo") ? "Jornada Comp." : (turno==="manana" ? "1/2 D√≠a (Ma√±ana)" : "1/2 D√≠a (Tarde)");
        inputDesc.value = `Alquiler Sal√≥n ${salon} - ${txtJornada}`;

        // BUSCAR PRECIO (L√≥gica del archivo TXT: replace/[^0-9.,]/g)
        const configHotel = salonesConfig[currentHotel] || [];
        const datos = configHotel.find(s => s.name.trim() === salon.trim());
        
       let p = 0;
if (datos) {
    // Usamos el motor com√∫n de limpieza num√©rica
    const pFull = parseCurrency(datos.priceFull);
    const pHalf = parseCurrency(datos.priceHalf);

    p = (turno === "dia_completo") ? pFull : pHalf;

    console.log("Detectado:", p); // Debug
}


        if(p > 0) inputPrice.value = p.toFixed(2) + " ‚Ç¨";
        else inputPrice.value = ""; 
        
        calcTotal();
    }

    function formatPrice(el) {
    const val = parseCurrency(el.value);

    // Si quieres que un 0 deje la celda vac√≠a:
    if (!val) {
        el.value = "";
        return;
    }

    el.value = val.toFixed(2) + " ‚Ç¨";
}



    function parseCurrency(str) {
    if (!str) return 0;

    let clean = String(str).trim();

    // 1) Quitar todo lo que no sea d√≠gito, coma, punto o signo -
    clean = clean.replace(/[^\d,.-]/g, '');

    // 2) Gestionar miles y decimales:
    const hasComma = clean.includes(',');
    const hasDot   = clean.includes('.');

    if (hasComma && hasDot) {
        // Caso m√°s habitual en Espa√±a: 1.234,56 ‚Ç¨
        clean = clean.replace(/\./g, '').replace(',', '.');
    } else if (hasComma && !hasDot) {
        // 123,45 -> 123.45
        clean = clean.replace(',', '.');
    }
    const n = parseFloat(clean);
    return isNaN(n) ? 0 : n;
}


    function calcTotal() {
    let total = 0;

    document.querySelectorAll("#bodyServicios tr").forEach(tr => {
        const udsInput   = tr.querySelector(".s-uds");
        const priceInput = tr.querySelector(".s-price");
        const totInput   = tr.querySelector(".s-tot");

        const uds   = parseFloat(udsInput?.value || "0") || 0;
        const price = parseCurrency(priceInput?.value || "0");

        const linea = uds * price;

        if (totInput) {
            totInput.value = linea ? linea.toFixed(2) + " ‚Ç¨" : "";
        }

        total += linea;
    });

    document.getElementById("totalAmount").innerText = total.toFixed(2);
}


    function updatePresupuestoDates() {
        const dates = [];
        document.querySelectorAll(".s-date").forEach(i => { if(i.value) dates.push(i.value); });
        if(dates.length > 0) {
            dates.sort();
            document.getElementById("inpFechaDesde").value = dates[0];
            document.getElementById("inpFechaHasta").value = dates[dates.length-1];
        }
    }

    async function guardarFicha() {
        const nombre = document.getElementById("inpNombre").value;
        if (!nombre) { alert("‚ö†Ô∏è Escribe un Nombre"); return; }
        
        const type = document.getElementById("dataType").value;
        
        const data = {
            hotel: currentHotel,
            type: type,
            nombre: nombre,
            tel: document.getElementById("inpTel").value,
            email: document.getElementById("inpEmail").value,
            salon: document.getElementById("inpSalon").value,
            notas: document.getElementById("inpNotas").value,
            notaCliente: document.getElementById("inpNotaCliente").value,
            fechaInicio: document.getElementById("inpFecha").value,
            updatedAt: new Date().toISOString()
        };

        if(type === 'presupuesto' || type === 'evento') {
            data.turno = document.getElementById("inpTurnoEvento").value;
            data.montaje = document.getElementById("inpMontaje").value;
            data.paxA = document.getElementById("inpPaxA").value;
            data.estado = document.getElementById("inpEstadoEvento").value;
            data.total = document.getElementById("totalAmount").innerText;
            data.fechaInicio = document.getElementById("inpFechaDesde").value || data.fechaInicio;
            data.fechaFin = document.getElementById("inpFechaHasta").value || data.fechaInicio;
            data.validez = data.fechaInicio;
            
            // GUARDAR SERVICIOS
            data.servicios = [];
            document.querySelectorAll("#bodyServicios tr").forEach(tr => {
                data.servicios.push({
                    date: tr.querySelector(".s-date").value,
                    desc: tr.querySelector(".s-desc").value,
                    uds: tr.querySelector(".s-uds").value,
                    price: parseCurrency(tr.querySelector(".s-price").value)
                });
            });
        } 
        else if (type === 'gran_evento') {
            data.aforo = document.getElementById("inpAforo").value;
            data.precioStd = document.getElementById("inpPrcStd").value;
            data.participantes = [];
            document.querySelectorAll("#bodyPart tr").forEach(tr => {
                data.participantes.push({
                    mesa: tr.querySelector(".p-mesa").value,
                    nombre: tr.querySelector(".p-nom").value,
                    pax: tr.querySelector(".p-pax").value,
                    precio: tr.querySelector(".p-prc").value,
                    pagado: tr.querySelector(".p-pag").value
                });
            });
        }

        const id = document.getElementById("dataId").value;
        try {
            if(id) await db.collection("master_data").doc(id).update(data);
            else await db.collection("master_data").add(data);
            
            if(type === "presupuesto" && data.estado === "confirmado") {
                await sincronizarEventosVinculados(id, data);
            }
            
            document.getElementById("modalFicha").style.display = "none";
            alert("‚úÖ Guardado");
        } catch(e) { alert("Error: " + e.message); }
    }

    async function confirmarPresupuesto() {
        if(!confirm("¬øConfirmar presupuesto? Esto reservar√° los d√≠as en el calendario.")) return;
        document.getElementById("inpEstadoEvento").value = "confirmado";
        await guardarFicha();
    }

    async function sincronizarEventosVinculados(idRef, data) {
        // Borrar anteriores
        const snap = await db.collection("master_data").where("refPresupuesto", "==", idRef).get();
        const batch = db.batch();
        snap.forEach(d => batch.delete(d.ref));
        
        // Crear nuevos d√≠as
        const d1 = new Date(data.fechaInicio); const d2 = new Date(data.fechaFin);
        const dias = (d2-d1)/(1000*60*60*24);
        
        for(let i=0; i<=dias; i++) {
            const d = new Date(d1); d.setDate(d.getDate()+i);
            const dateStr = d.toISOString().split("T")[0];
            const ref = db.collection("master_data").doc();
            batch.set(ref, {
                hotel: currentHotel, type: 'evento', 
                nombre: data.nombre, salon: data.salon,
                fechaInicio: dateStr, fechaFin: dateStr,
                estado: 'confirmado', refPresupuesto: idRef,
                turno: data.turno
            });
        }
        await batch.commit();
    }

    function abrirModalId(id) {
        const d = dataCache.find(x => x.id === id);
        if(!d) return;
        
        // Simular navegaci√≥n para configurar modal
        const prevMod = currentModule;
        // Forzar cambio de m√≥dulo temporal para pintar el modal correcto
        if(d.type==='gran_evento') currentModule='grandes_eventos';
        else if(d.type==='restaurante') currentModule='restaurante';
        else currentModule='presupuestos'; // por defecto para eventos
        
        nuevo(d.fechaInicio, d.salon, "");
        currentModule = prevMod; // Restaurar

        document.getElementById("dataId").value = d.id;
        document.getElementById("inpNombre").value = d.nombre;
        document.getElementById("modalTitle").innerText = d.nombre;
        document.getElementById("inpTel").value = d.tel||"";
        document.getElementById("inpEmail").value = d.email||"";
        document.getElementById("inpNotas").value = d.notas||"";
        
        if(d.type === 'presupuesto' || d.type === 'evento') {
            document.getElementById("inpEstadoEvento").value = d.estado;
            document.getElementById("inpTurnoEvento").value = d.turno;
            document.getElementById("inpMontaje").value = d.montaje;
            document.getElementById("inpPaxA").value = d.paxA;
            document.getElementById("inpFechaDesde").value = d.fechaInicio;
            document.getElementById("inpFechaHasta").value = d.fechaFin;
            document.getElementById("refPresupuesto").value = d.refPresupuesto || "";
            
            document.getElementById("bodyServicios").innerHTML = "";
            if(d.servicios) {
                d.servicios.forEach(s => addServiceRow(s));
            }
            calcTotal();
        } else if (d.type === 'gran_evento') {
            document.getElementById("inpAforo").value = d.aforo;
            document.getElementById("inpPrcStd").value = d.precioStd;
            document.getElementById("bodyPart").innerHTML = "";
            if(d.participantes) d.participantes.forEach(p => addPart(p));
            calcGran();
        }

        document.getElementById("btnGuardarMain").innerText = "GUARDAR CAMBIOS";
        document.getElementById("btnRecuperar").style.display = (d.estado==='anulado') ? 'inline-flex' : 'none';
        document.getElementById("btnAnular").style.display = (d.estado!=='anulado') ? 'inline-flex' : 'none';
    }

    function imprimirPDF() {
        const typeEl = document.getElementById("dataType"); 
        // Permitimos imprimir en cualquier caso si estamos en el m√≥dulo correcto
        if ((!typeEl || typeEl.value !== "presupuesto") && currentModule !== "presupuestos") { 
             // Opcional: alert("Imprimiendo ficha...");
        }

        const escapeHTML = (str = "") => String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const nl2br = (str = "") => escapeHTML(str).replace(/\r\n|\n/g, "<br>");
        const getInputValue = (id) => document.getElementById(id)?.value?.trim() || "";
        const getTextValue = (id) => document.getElementById(id)?.innerText?.trim() || "";
        const formatISODate = (iso) => { if (!iso) return ""; const [y, m, d] = iso.split("-"); return `${d}/${m}/${y}`; };
        
        const HOTEL_CONFIG = { Cumbria: { nombre: "Cumbria Spa&Hotel", linea: "Presupuesto", dir: "Ctra. de Toledo, 26", tel: "926 25 04 04", logoRel: "Img/logo-cumbria.svg" }, Guadiana: { nombre: "Sercotel Guadiana", linea: "Presupuesto", dir: "C/ Guadiana, 36", tel: "926 22 33 13", logoRel: "Img/logo-guadiana.svg" } };
        const hotelInfo = HOTEL_CONFIG[currentHotel] || HOTEL_CONFIG["Guadiana"];
        
        let filasServicios = ""; 
        document.querySelectorAll("#bodyServicios tr").forEach((tr) => {
            const fecha = formatISODate(tr.querySelector(".s-date")?.value);
            const desc = tr.querySelector(".s-desc")?.value;
            const uds = tr.querySelector(".s-uds")?.value;
            const price = tr.querySelector(".s-price")?.value;
            const tot = tr.querySelector(".s-tot")?.value;
            filasServicios += `<tr><td>${escapeHTML(fecha)}</td><td>${escapeHTML(desc)}</td><td class="num">${escapeHTML(uds)}</td><td class="num">${escapeHTML(price)}</td><td class="num">${escapeHTML(tot)}</td></tr>`;
        });

        const html = `<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"><title>Presupuesto</title><style>
            body{font-family:sans-serif; font-size:12px; margin:0; padding:20px; color:#333;}
            .header{display:flex; justify-content:space-between; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:20px;}
            .logo img{height:50px;}
            table{width:100%; border-collapse:collapse; margin-bottom:20px;}
            th{background:#f8f9fa; text-align:left; padding:8px; border-bottom:1px solid #ddd;}
            td{padding:8px; border-bottom:1px solid #eee;}
            .num{text-align:right;}
            .total{text-align:right; font-size:16px; font-weight:bold; margin-top:10px;}
            .notes{background:#f9f9f9; padding:10px; border-radius:5px; margin-top:20px;}
        </style></head><body>
            <div class="header">
                <div><img src="${hotelInfo.logoRel}" style="height:50px;"> <br> <strong>${hotelInfo.nombre}</strong><br>${hotelInfo.dir}</div>
                <div style="text-align:right;"><strong>PRESUPUESTO</strong><br>Fecha: ${new Date().toLocaleDateString()}<br>Ref: ${getInputValue('refPresupuesto')||'BORRADOR'}</div>
            </div>
            <h3>Cliente: ${getInputValue('inpNombre')}</h3>
            <table><thead><tr><th>Fecha</th><th>Concepto</th><th class="num">Uds</th><th class="num">Precio</th><th class="num">Total</th></tr></thead><tbody>${filasServicios}</tbody></table>
            <div class="total">TOTAL: ${getTextValue('totalAmount')} ‚Ç¨</div>
            <div class="notes"><strong>Notas:</strong><br>${nl2br(getInputValue('inpNotaCliente') || getInputValue('inpNotas'))}</div>
            <br><br><br>
            <div style="display:flex; justify-content:space-between;"><div>Firma Cliente</div><div>Firma Hotel</div></div>
        </body></html>`;
        
        const win = window.open("", "_blank"); 
        if (!win) { alert("Permite pop-ups"); return; }
        win.document.write(html); win.document.close(); win.focus(); 
        setTimeout(() => win.print(), 500);
    }
    
    // Funciones Auxiliares Grandes Eventos
    function addPart(d={}) { const tr=document.createElement("tr"); tr.innerHTML=`<td><input class="svc-input p-mesa" value="${d.mesa||''}"></td><td><input class="svc-input p-nom" value="${d.nombre||''}"></td><td><input type="number" class="svc-input p-pax" value="${d.pax||1}" oninput="calcGran()"></td><td><input type="number" class="svc-input p-prc" value="${d.precio||''}" oninput="calcGran()"></td><td><input type="number" class="svc-input p-pag" value="${d.pagado||0}" oninput="calcGran()"></td>`; document.getElementById("bodyPart").appendChild(tr); }
    function calcGran() {
        let pax=0, tot=0, pag=0;
        document.querySelectorAll("#bodyPart tr").forEach(tr => {
            const p = parseFloat(tr.querySelector(".p-pax").value)||0;
            const pr = parseFloat(tr.querySelector(".p-prc").value)||0;
            const pg = parseFloat(tr.querySelector(".p-pag").value)||0;
            pax+=p; tot+=(p*pr); pag+=pg;
        });
        document.getElementById("gPax").innerText = pax;
        document.getElementById("gTot").innerText = tot.toFixed(2);
        document.getElementById("gPend").innerText = (tot-pag).toFixed(2);
    }
    function aplicarStd() { const v=document.getElementById("inpPrcStd").value; document.querySelectorAll(".p-prc").forEach(i=>{i.value=v}); calcGran(); }

    // Utils
    function safeDate(val) { if(!val) return new Date(); if(val instanceof Date) return val; if(val.includes("-")) { const parts = val.split("-"); return new Date(parts[0], parts[1]-1, parts[2]); } return new Date(val); }
    // FECHA CORRECTA: Lun 1 Dic 25
    function formatearFechaListado(s) { 
        if(!s) return "-"; 
        const d=safeDate(s); 
        const dias = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
        const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        return `${dias[d.getDay()]} ${d.getDate()} ${meses[d.getMonth()]} ${d.getFullYear().toString().slice(-2)}`; 
    }
    function cambiarSemana(d) { const i=document.getElementById("fechaVista"); const dt=safeDate(i.value); dt.setDate(dt.getDate()+d); i.valueAsDate=dt; render(); }
    function checkSalonPendiente(s) { s.style.border = (s.value==="Pendiente") ? "2px solid orange" : "1px solid #cbd5e1"; }
</script>
</body>
</html>