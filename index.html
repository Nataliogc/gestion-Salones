<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestor de Eventos ‚Äì Guadiana & Cumbria</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
        :root {
            --primary: #263238; /* Gris oscuro elegante */
            --accent: #546e7a;
            --bg-body: #f0f2f5;
            --surface: #ffffff;
            --border: #dfe3e8;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { margin: 0; background: var(--bg-body); color: #1a1a1a; font-size: 13px; }

        /* --- NUEVO LANDING PAGE (ESTILO MODERNO) --- */
        #landingPage {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%);
        }
        .landing-container {
            background: var(--surface);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 900px;
            width: 100%;
        }
        .landing-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        .brand-logo {
            width: 64px;
            height: 64px;
            background: linear-gradient(180deg, #37474f 0%, #263238 100%);
            color: #fff;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .brand-text h1 { margin: 0; font-size: 22px; color: #111827; letter-spacing: -0.5px; text-transform: uppercase; }
        .brand-text p { margin: 4px 0 0; color: #6b7280; font-size: 14px; }
        .beta-badge {
            margin-left: auto;
            background: #d1fae5; color: #065f46;
            padding: 4px 12px; border-radius: 99px;
            font-size: 12px; font-weight: 600;
        }
        .hotel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .h-card {
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fff;
            position: relative;
            overflow: hidden;
        }
        .h-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.06); border-color: #90a4ae; }
        .h-card h3 { margin: 0 0 8px; font-size: 18px; color: #1f2937; }
        .h-card p { margin: 0 0 20px; color: #6b7280; font-size: 13px; line-height: 1.5; }
        .h-tag {
            display: inline-flex; align-items: center; gap: 6px;
            background: #f3f4f6; color: #4b5563;
            padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 500;
        }
        .landing-footer { margin-top: 30px; text-align: center; color: #9ca3af; font-size: 11px; }

        /* --- APP LAYOUT --- */
        #appContainer { display: none; min-height: 100vh; flex-direction: column; }
        .app-header {
            background: #fff; border-bottom: 1px solid var(--border);
            padding: 10px 24px; display: flex; justify-content: space-between; align-items: center;
        }
        .controls-bar { padding: 15px 24px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
        
        /* --- TABLA & FILAS M√ÅS ALTAS --- */
        .table-wrapper { margin: 0 20px 20px; background: #fff; border-radius: 12px; box-shadow: var(--shadow); overflow: auto; }
        table { border-collapse: collapse; width: 100%; }
        th { background: #f8fafc; padding: 12px; text-align: left; border-bottom: 1px solid var(--border); color: #64748b; font-weight: 600; font-size: 11px; text-transform: uppercase;}
        td { border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        
        /* AQU√ç EST√Å EL CAMBIO DE ALTURA */
        .split-cell {
            display: flex; flex-direction: column;
            height: 140px; /* AUMENTADO DE 60px A 140px */
            width: 100%; position: relative;
        }
        .split-zone { flex: 1; border-bottom: 1px dotted #e2e8f0; display: flex; align-items: center; padding: 0 4px; transition: 0.1s; cursor: pointer; }
        .split-zone:last-child { border-bottom: none; }
        .split-zone:hover { background: #f8fafc; }

        /* Estilos Eventos */
        .evt-full-day {
            position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px;
            background: #dbeafe; color: #1e40af; border-left: 4px solid #2563eb;
            border-radius: 4px; padding: 6px; font-size: 11px; z-index: 2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden;
        }
        .evt-part {
            width: 100%; height: 90%; border-radius: 4px; padding: 4px 6px; font-size: 11px;
            display: flex; align-items: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .evt-manana { background: #fef3c7; color: #92400e; border-left: 3px solid #d97706; }
        .evt-tarde { background: #f3e8ff; color: #6b21a8; border-left: 3px solid #9333ea; }

        /* Estilos Restaurante */
        .cell-restaurante { padding: 4px; }
        .rest-zone { min-height: 60px; border: 1px dashed #cbd5e1; border-radius: 8px; margin-bottom: 4px; padding: 4px; }
        .mesa-card { display: block; background: #fff; border: 1px solid #e2e8f0; padding: 4px 8px; margin-bottom: 4px; border-radius: 4px; font-size: 11px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Botones */
        button { cursor: pointer; border: none; font-family: inherit; }
        .btn-primary { background: #0f172a; color: #fff; padding: 8px 16px; border-radius: 8px; font-weight: 500; }
        .btn-secondary { background: #fff; border: 1px solid #cbd5e1; color: #334155; padding: 8px 16px; border-radius: 8px; }
        .btn-print { background: #7c3aed; color: #fff; padding: 8px 16px; border-radius: 8px; font-weight: 500; display: inline-flex; gap:6px; align-items: center;}
        
        /* Modales */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 50; justify-content: center; align-items: center; padding: 20px;}
        .modal-content { background: #fff; width: 100%; max-width: 900px; max-height: 90vh; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .modal-body { padding: 20px; overflow-y: auto; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; display: flex; flex-direction: column; }
        input, select, textarea { padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; margin-top: 4px; }
    </style>
</head>
<body>
<div id="landingPage">
        <div class="landing-container">
            <div class="landing-header">
                <div class="brand-logo">HR</div>
                <div class="brand-text">
                    <h1>Reservas Salas y Restaurante</h1>
                    <p>Gesti√≥n unificada de presupuestos, salones y restaurante para <strong>Sercotel Guadiana</strong> y <strong>Cumbria Spa&Hotel</strong>.</p>
                </div>
                <div class="beta-badge">‚óè Beta interna</div>
            </div>

            <div class="hotel-grid">
                <div class="h-card" onclick="initApp('Guadiana')">
                    <h3>Sercotel Guadiana</h3>
                    <p>Salones, eventos sociales y comidas de empresa.</p>
                    <div class="h-tag">üèõÔ∏è Ciudad Real ¬∑ Centro</div>
                </div>

                <div class="h-card" onclick="initApp('Cumbria')">
                    <h3>Cumbria Spa&Hotel</h3>
                    <p>Convenciones, grupos deportivos y grandes banquetes.</p>
                    <div class="h-tag">üåÑ Ciudad Real ¬∑ Zona Norte</div>
                </div>
            </div>

            <div class="landing-footer">
                Panel interno de trabajo. <strong>No compartir enlace</strong> con clientes ni agencias. Versi√≥n conectada a Firebase.
            </div>
        </div>
    </div>

    <div id="appContainer" style="display: none">
        <div class="app-header">
            <div class="header-left">
                <button class="btn-back" onclick="location.reload()">‚¨Ö</button>

                <h2 id="tituloHotelActual" class="header-title">Hotel</h2>
                <img id="headerLogo" />

                <div class="connection-badge status-offline" id="statusBadge">
                    <span class="status-dot"></span>
                    <span id="statusText">Conectando...</span>
                </div>
            </div>

            <div class="module-tabs">
                <button class="tab-btn active" onclick="setModulo('eventos')" id="btnModEventos">üìÖ Salones</button>
                <button class="tab-btn" onclick="setModulo('restaurante')" id="btnModRest">üç¥ Restaurante</button>
                <button class="tab-btn" onclick="setModulo('presupuestos')" id="btnModPpto">üìÑ Presupuestos</button>
            </div>
        </div>

     <div class="controls-bar">
    <div class="left-controls">
        <input type="date" id="fechaVista" onchange="render()" />
        <select id="filtroEstado" onchange="render()">
            <option value="todos">Ver activos</option>
            <option value="pendiente">‚è≥ Pendientes</option>
            <option value="confirmado">‚úÖ Confirmados</option>
            <option value="anulado">‚ùå Anulados</option>
        </select>
    </div>

    <div style="display:flex; gap:10px;">
        <button class="btn-print" onclick="generarOrdenServicio()">üñ®Ô∏è Orden de Servicio</button>
        <button class="btn-primary" id="btnNuevoPrincipal" onclick="nuevoGeneral()">+ Nuevo</button>
    </div>
</div>

        <div class="table-wrapper">
            <table id="mainTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>

            <div id="presupuestosContainer" style="display: none">
                <table class="budget-table">
                    <thead>
                        <tr>
                            <th style="width: 120px">Fecha</th>
                            <th>Cliente</th>
                            <th>Sal√≥n</th>
                            <th style="width: 150px">Ref</th>
                            <th style="width: 120px">Estado</th>
                            <th style="width: 120px; text-align: right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="budgetBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalFicha">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Ficha</h3>
                <button class="btn-close-x" onclick="cerrarModal()">√ó</button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="dataId" />
                <input type="hidden" id="dataType" />
                <input type="hidden" id="refPresupuesto" />
                <input type="hidden" id="fechaEmision" />

                <div class="form-row" style="background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <div class="form-group" id="grpFechaUnica">
                        <label>Fecha</label>
                        <input type="date" id="inpFecha" />
                    </div>

                    <div class="form-group" id="grpRangoFechas" style="display: none">
                        <div class="form-row" style="gap: 6px">
                            <div class="form-group">
                                <label>Desde</label>
                                <input type="date" id="inpFechaDesde" />
                            </div>
                            <div class="form-group">
                                <label>Hasta</label>
                                <input type="date" id="inpFechaHasta" />
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Espacio / Sal√≥n</label>
                        <select id="inpSalon"></select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 2">
                        <label>Cliente / Evento</label>
                        <input type="text" id="inpNombre" />
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="text" id="inpTel" />
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="text" id="inpEmail" />
                    </div>
                </div>

               <div class="form-row" id="blockRestaurante" style="display: none; background: #fff8e1; padding: 10px; border-radius: 8px; border: 1px solid #ffe082;">
    <div class="form-group">
        <label>Hora Reserva</label>
        <input type="time" id="inpHora" />
    </div>
    <div class="form-group">
        <label>N¬∫ Pax</label>
        <input type="number" id="inpPaxRest" />
    </div>
    <div class="form-group">
        <label>Turno</label>
        <select id="inpTurno">
            <option value="manana">‚òÄÔ∏è Almuerzo</option>
            <option value="tarde">üåô Cena</option>
        </select>
    </div>
    <div class="form-group">
        <label>Estado Reserva</label>
        <select id="inpEstadoRest">
            <option value="confirmado">‚úÖ Confirmada</option>
            <option value="lista_espera">‚è≥ Lista de Espera</option>
        </select>
    </div>
</div>
                <div id="blockEventos">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Jornada / Turno</label>
                            <select id="inpTurnoEvento">
                                <option value="dia_completo">Todo el d√≠a</option>
                                <option value="manana">‚òÄÔ∏è Ma√±ana</option>
                                <option value="tarde">üåô Tarde</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Montaje</label>
                            <select id="inpMontaje">
                                <option>Banquete</option>
                                <option>Escuela</option>
                                <option>Teatro</option>
                                <option>C√≥ctel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Pax Adultos</label>
                            <input type="number" id="inpPaxA" />
                        </div>
                        <div class="form-group">
                            <label>Pax Ni√±os</label>
                            <input type="number" id="inpPaxN" />
                        </div>
                    </div>

                    <div style="margin-top: 10px">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <label style="color: var(--primary-dark); font-weight: 700;">DESGLOSE ECON√ìMICO</label>
                            <button class="btn-ai" id="btnMenuIA" onclick="generarMenuIA()">üçΩÔ∏è Sugerir Men√∫ IA</button>
                        </div>

                        <table class="svc-table">
                            <thead>
                                <tr>
                                    <th style="width: 130px">Fecha</th>
                                    <th>Concepto</th>
                                    <th style="width: 60px">Uds.</th>
                                    <th style="width: 80px">Precio</th>
                                    <th style="width: 80px">Total</th>
                                    <th style="width: 26px"></th>
                                </tr>
                            </thead>
                            <tbody id="bodyServicios"></tbody>
                        </table>

                        <button class="btn-add-row" type="button" onclick="addServiceRow()">+ A√±adir l√≠nea</button>

                        <div style="text-align: right; font-size: 16px; font-weight: 700; margin-top: 10px;">
                            TOTAL: <span id="totalAmount" style="color: var(--primary)">0.00</span> ‚Ç¨
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 10px">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <label>Notas / Alergias</label>
                        <button class="btn-ai" id="btnNotasIA" onclick="mejorarNotasConIA()" type="button">‚ú® Mejorar redacci√≥n</button>
                    </div>
                    <textarea id="inpNotas" rows="3"></textarea>
                </div>
            </div>

            <div class="modal-footer">
    <button class="btn-ai" id="btnEmailIA" onclick="redactarEmailIA()" type="button">üìß Redactar Email Cliente</button>
    
    <button class="btn-secondary" id="btnPdf" onclick="imprimirPDF()" type="button">üìÑ PDF Presupuesto</button>

    <div style="flex: 1"></div>

    <button class="btn-primary" type="button" id="btnConfirmarPpto" onclick="confirmarPresupuesto()" style="display:none;">Confirmar</button>

    <button class="btn-primary" type="button" id="btnRecuperar" onclick="recuperarFicha()" style="display:none; background-color: #ff9800;">‚Ü∫ Recuperar</button>
    
    <button class="btn-anular" type="button" id="btnAnular" onclick="anularFicha()">Anular</button>
    <button class="btn-primary" type="button" onclick="guardarFicha()">GUARDAR</button>
</div>
        </div>
    </div>

    <div class="modal-overlay" id="aiResponseModal">
        <div class="ai-content">
            <h3>ü§ñ Sugerencia IA</h3>
            <textarea id="aiOutput" style="width: 100%; height: 200px; margin: 10px 0; padding: 10px"></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px">
                <button class="btn-secondary" type="button" onclick="document.getElementById('aiResponseModal').style.display='none'">Cerrar</button>
                <button class="btn-primary" type="button" onclick="copiarIA()">Copiar / Usar</button>
            </div>
        </div>
    </div>

    <script>
    /* FIREBASE */
    const firebaseConfig = {
        apiKey: "AIzaSyBAK0sGUYpV8KHy1KwIdNRLtHlq5LT3Vwg",
        authDomain: "gestionsalones-bba4b.firebaseapp.com",
        projectId: "gestionsalones-bba4b",
        storageBucket: "gestionsalones-bba4b.firebasestorage.app",
        messagingSenderId: "860164285474",
        appId: "1:860164285474:web:ff995e88093e5aa5eb167b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* GEMINI */
    const apiKey = "AIzaSyBdtp8vZeXmIMXG9lHHj9TY9z0mq9OzlJA";

    /* ESTADO */
    let currentHotel = null;
    let currentModule = "eventos";
    let dataCache = [];

    const salones = {
        Guadiana: [
            "Puerta de Alarcos",    // 570m2
            "Puerta de Calatrava",  // 125m2
            "Puerta del Carmen",    // 110m2
            "Puerta de Ciruela",    // 25m2
            "Puerta de Granada",    // 120m2
            "Puerta de Santa Mar√≠a",// 70m2
            "Puerta de Toledo",     // 150m2
            "Restaurante",
            "Cafeter√≠a"
        ],
        Cumbria: [
            "Sal√≥n Mercurio",       // 77m2
            "Sal√≥n Venus",          // 77m2
            "Sal√≥n La Tierra",      // 68m2
            "Sal√≥n Marte",          // 77m2
            "Sal√≥n J√∫piter",        // 68m2
            "Restaurante",
            "Cafeter√≠a"
        ]
    };

    function initApp(hotel) {
        currentHotel = hotel;
        document.getElementById("landingPage").style.display = "none";
        document.getElementById("appContainer").style.display = "block";
        document.getElementById("tituloHotelActual").innerText = hotel;
        document.getElementById("headerLogo").src = hotel === "Guadiana" ? "Img/logo-guadiana.svg" : "Img/logo-cumbria.svg";
        document.getElementById("fechaVista").valueAsDate = new Date();
        cargarDatos();
    }

    function cargarDatos() {
        db.collection("master_data").onSnapshot((snap) => {
            const badge = document.getElementById("statusBadge");
            badge.classList.remove("status-offline");
            badge.classList.add("status-online");
            document.getElementById("statusText").innerText = "Conectado";
            dataCache = [];
            snap.forEach((d) => dataCache.push({ id: d.id, ...d.data() }));
            render();
        }, () => {
            const badge = document.getElementById("statusBadge");
            badge.classList.remove("status-online");
            badge.classList.add("status-offline");
            document.getElementById("statusText").innerText = "Sin conexi√≥n";
        });
    }

    function setModulo(m) {
        currentModule = m;
        document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
        const btnId = m === "eventos" ? "btnModEventos" : m === "restaurante" ? "btnModRest" : "btnModPpto";
        document.getElementById(btnId).classList.add("active");
        let txt = m === "eventos" ? "Nuevo Evento" : m === "restaurante" ? "Nueva Mesa" : "Nuevo Presupuesto";
        document.getElementById("btnNuevoPrincipal").innerText = "+ " + txt;
        if (m === "presupuestos") {
            document.getElementById("mainTable").style.display = "none";
            document.getElementById("presupuestosContainer").style.display = "block";
        } else {
            document.getElementById("mainTable").style.display = "table";
            document.getElementById("presupuestosContainer").style.display = "none";
        }
        render();
    }
function render() {
        const thead = document.getElementById("tableHead");
        const tbody = document.getElementById("tableBody");
        thead.innerHTML = "";
        tbody.innerHTML = "";

        const filtroState = document.getElementById("filtroEstado").value;
        let filtered = dataCache.filter((d) => d.hotel === currentHotel);

        // --- PRESUPUESTOS ---
        if (currentModule === "presupuestos") {
            filtered = filtered.filter((d) => {
                if (d.type !== "presupuesto") return false;
                if (filtroState === "todos") return d.estado !== "anulado";
                if (filtroState === "anulado") return d.estado === "anulado";
                return d.estado === filtroState;
            });
            const bodyP = document.getElementById("budgetBody");
            bodyP.innerHTML = "";
            filtered.forEach((item) => {
                const tr = document.createElement("tr");
                tr.className = "budget-row";
                tr.innerHTML = `
                    <td style="padding: 8px 10px;">${item.fechaInicio || ""}</td>
                    <td><strong>${item.nombre || ""}</strong></td>
                    <td>${item.salon || ""}</td>
                    <td>${item.ref || "-"}</td>
                    <td><span class="badge ${item.estado === "anulado" ? "st-anulado" : "st-activo"}">${item.estado || "activo"}</span></td>
                    <td style="text-align:right; font-weight:bold;">${item.total || 0} ‚Ç¨</td>`;
                tr.onclick = () => abrirModalId(item.id);
                bodyP.appendChild(tr);
            });
            return;
        }

        // --- CALENDARIO (SALONES Y RESTAURANTE) ---
        const fVista = document.getElementById("fechaVista").value;
        const tipoBusca = currentModule === "restaurante" ? "restaurante" : "evento";
        
        // 1. GENERAR CABECERA CON FORMATO "Sab 29 Nov 25"
        let headerHTML = '<tr><th style="width:200px; left:0; z-index:5;">ESPACIO</th>';
        
        const diasSem = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
        const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];

        for (let i = 0; i < 7; i++) {
            const d = new Date(fVista);
            d.setDate(d.getDate() + i);
            
            const nombreDia = diasSem[d.getDay()];
            const numDia = d.getDate();
            const nombreMes = meses[d.getMonth()];
            const year = String(d.getFullYear()).slice(-2); // Cogemos los √∫ltimos 2 d√≠gitos

            // Formato final: Sab 29 Nov 25
            headerHTML += `<th style="font-size:12px; text-align:center;">${nombreDia} ${numDia} ${nombreMes} ${year}</th>`;
        }
        headerHTML += "</tr>";
        thead.innerHTML = headerHTML;

        const spaces = salones[currentHotel].filter((s) => {
            if (currentModule === "restaurante") return s.includes("Restaurante") || s.includes("Cafeter√≠a");
            return !s.includes("Restaurante") && !s.includes("Cafeter√≠a");
        });

        spaces.forEach((salon) => {
            const tr = document.createElement("tr");
            let tds = `<td style="font-weight:bold; padding-left:16px; position:sticky; left:0; background:#fff; z-index:4;">${salon}</td>`;

            for (let i = 0; i < 7; i++) {
                const d = new Date(fVista);
                d.setDate(d.getDate() + i);
                const dStr = d.toISOString().split("T")[0]; // Para comparar fechas

                const items = filtered.filter((x) => {
                    if (x.type !== tipoBusca || x.salon !== salon) return false;
                    
                    // L√≥gica de Filtro
                    if (filtroState === "todos") { if (x.estado === "anulado") return false; }
                    else if (filtroState === "anulado") { if (x.estado !== "anulado") return false; }
                    else { if (x.estado !== filtroState) return false; }

                    if (currentModule === "restaurante") return x.fechaInicio === dStr;
                    const inicio = x.fechaInicio || dStr;
                    const fin = x.fechaFin || inicio;
                    return inicio <= dStr && dStr <= fin;
                });

                if (currentModule === "restaurante") {
                    // --- L√ìGICA RESTAURANTE ---
                    const alm = items.filter((x) => x.turno === "manana").map((x) => {
                        let style = "";
                        let icon = "‚úÖ ";
                        if (x.estado === 'anulado') {
                            style = 'background:#ffebee; color:#c62828; border:1px solid #ef9a9a; opacity:0.7; text-decoration:line-through;';
                            icon = "‚ùå ";
                        } else if (x.estado === 'lista_espera') {
                            style = 'background: #ffffff; color: #e65100; border: 2px dashed #ff6d00; font-weight: bold;';
                            icon = "‚è≥ ";
                        }
                        return `<div class="mesa-card mesa-manana" style="${style}" onclick="event.stopPropagation(); abrirModalId('${x.id}')"><b>${icon}${x.hora || ""}</b> ${x.nombre || ""} <small>(${x.paxRest || "?"}p)</small></div>`;
                    }).join("");

                    const cen = items.filter((x) => x.turno === "tarde").map((x) => {
                        let style = "";
                        let icon = "‚úÖ ";
                        if (x.estado === 'anulado') {
                            style = 'background:#ffebee; color:#c62828; border:1px solid #ef9a9a; opacity:0.7; text-decoration:line-through;';
                            icon = "‚ùå ";
                        } else if (x.estado === 'lista_espera') {
                            style = 'background: #ffffff; color: #4a148c; border: 2px dashed #6200ea; font-weight: bold;';
                            icon = "‚è≥ ";
                        }
                        return `<div class="mesa-card mesa-tarde" style="${style}" onclick="event.stopPropagation(); abrirModalId('${x.id}')"><b>${icon}${x.hora || ""}</b> ${x.nombre || ""} <small>(${x.paxRest || "?"}p)</small></div>`;
                    }).join("");

                    tds += `<td class="cell-restaurante"><div class="rest-zone" onclick="nuevoRest('${dStr}','${salon}','manana')">${alm}</div><div class="rest-zone" onclick="nuevoRest('${dStr}','${salon}','tarde')">${cen}</div></td>`;
                    
                } else {
                    // --- L√ìGICA SALONES (SIN TEXTO MA√ëANA/TARDE) ---
                    const evtDiaCompleto = items.find(x => x.turno === "dia_completo" && x.estado !== "anulado");
                    const evtManana = items.find(x => x.turno === "manana" && x.estado !== "anulado");
                    const evtTarde = items.find(x => x.turno === "tarde" && x.estado !== "anulado");

                    let content = "";

                    if (evtDiaCompleto) {
                        let style = "";
                        if(evtDiaCompleto.estado === "confirmado") style = "background:#c8e6c9; color:#2e7d32; border:1px solid #81c784;"; 
                        
                        content = `
                            <div class="split-cell">
                                <div class="evt-full-day" style="${style}" onclick="event.stopPropagation(); abrirModalId('${evtDiaCompleto.id}')">
                                    üìÖ ${evtDiaCompleto.nombre}
                                </div>
                            </div>`;
                    } else {
                        // 2. Quitamos el texto "Ma√±ana" y "Tarde", dejamos string vac√≠o ""
                        let htmlManana = ""; 
                        if (evtManana) {
                             let styleM = "";
                             if(evtManana.estado === "confirmado") styleM = "background:#fff9c4; color:#f9a825; font-weight:bold;";
                             htmlManana = `<div class="evt-part evt-manana" style="${styleM}" onclick="event.stopPropagation(); abrirModalId('${evtManana.id}')">
                                ‚òÄÔ∏è ${evtManana.nombre}
                             </div>`;
                        }

                        let htmlTarde = ""; 
                        if (evtTarde) {
                             let styleT = "";
                             if(evtTarde.estado === "confirmado") styleT = "background:#e1bee7; color:#6a1b9a; font-weight:bold;";
                             htmlTarde = `<div class="evt-part evt-tarde" style="${styleT}" onclick="event.stopPropagation(); abrirModalId('${evtTarde.id}')">
                                üåô ${evtTarde.nombre}
                             </div>`;
                        }

                        content = `
                            <div class="split-cell">
                                <div class="split-zone" onclick="nuevoSalon('${dStr}','${salon}', 'manana')">
                                    ${htmlManana}
                                </div>
                                <div class="split-zone" onclick="nuevoSalon('${dStr}','${salon}', 'tarde')">
                                    ${htmlTarde}
                                </div>
                            </div>`;
                    }
                    tds += `<td class="cell-salon" style="padding:0; vertical-align:middle;">${content}</td>`;
                }
            }
            tr.innerHTML = tds;
            tbody.appendChild(tr);
        });
    }
    function cerrarModal() {
        document.getElementById("modalFicha").style.display = "none";
    }
// 1. ACTUALIZAR NUEVOGENERAL (Para permitir rangos en eventos)
    function nuevoGeneral() {
        document.getElementById("dataId").value = "";
        document.getElementById("inpNombre").value = "";
        document.getElementById("inpTel").value = "";
        document.getElementById("inpEmail").value = "";
        document.getElementById("inpNotas").value = "";
        document.getElementById("bodyServicios").innerHTML = "";
        document.getElementById("totalAmount").innerText = "0.00";
        document.getElementById("inpHora").value = "";
        document.getElementById("inpPaxRest").value = "";

        const tipo = currentModule === "restaurante" ? "restaurante" : currentModule === "presupuestos" ? "presupuesto" : "evento";
        document.getElementById("dataType").value = tipo;
        
        const isRest = tipo === "restaurante";
        const isPpto = tipo === "presupuesto";
        const isEvt = tipo === "evento";

        document.getElementById("modalTitle").innerText = isRest ? "Nueva Mesa" : (isPpto ? "Nuevo Presupuesto" : "Nuevo Evento / Bloqueo");
        
        // VISIBILIDAD DE BLOQUES
        document.getElementById("blockRestaurante").style.display = isRest ? "block" : "none";
        document.getElementById("blockEventos").style.display = isRest ? "none" : "block";

        // FECHAS: Ahora mostramos Rango tambi√©n para Eventos (para poder bloquear "desde-hasta")
        document.getElementById("grpFechaUnica").style.display = (isPpto || isEvt) ? "none" : "block"; 
        document.getElementById("grpRangoFechas").style.display = (isPpto || isEvt) ? "flex" : "none";

        // Si es restaurante, usa fecha unica
        if(isRest) document.getElementById("grpFechaUnica").style.display = "block";

        // Botones
        document.getElementById("btnPdf").style.display = isPpto ? "inline-flex" : "none";
        document.getElementById("btnMenuIA").style.display = isPpto ? "inline-flex" : "none";
        document.getElementById("btnConfirmarPpto").style.display = isPpto ? "inline-flex" : "none";
        
        document.getElementById("btnAnular").style.display = "none";
        document.getElementById("btnRecuperar").style.display = "none";

        // Valores por defecto
        if(isRest) document.getElementById("inpEstadoRest").value = "confirmado";
        if(isEvt) document.getElementById("inpTurnoEvento").value = "dia_completo";

        // Salones
        const sel = document.getElementById("inpSalon");
        sel.innerHTML = "";
        if (isPpto) sel.innerHTML = `<option value="Pendiente">-- Pendiente --</option>`;
        salones[currentHotel].forEach((s) => {
            if (isRest) { if (s.includes("Restaurante") || s.includes("Cafeter√≠a")) sel.innerHTML += `<option>${s}</option>`; } 
            else { if (!s.includes("Restaurante")) sel.innerHTML += `<option>${s}</option>`; }
        });

        const hoy = new Date().toISOString().split("T")[0];
        document.getElementById("inpFecha").value = hoy;
        document.getElementById("inpFechaDesde").value = hoy;
        document.getElementById("inpFechaHasta").value = hoy;

        if (isPpto) addServiceRow({ date: hoy });
        document.getElementById("modalFicha").style.display = "flex";
    }

    // 2. FUNCI√ìN AUXILIAR (A√±√°dela si no la tienes)
    function sumarDiasFecha(fechaStr, dias) {
        const parts = fechaStr.split('-');
        const d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);
        d.setDate(d.getDate() + dias);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // 3. ACTUALIZAR GUARDARFICHA (Para crear bucle de eventos si es rango)
    function guardarFicha(estadoOverride, skipClose) {
        try {
            const id = document.getElementById("dataId").value;
            const type = document.getElementById("dataType").value;
            const nombre = document.getElementById("inpNombre").value;
            if (!nombre) { alert("El nombre es obligatorio."); return Promise.reject(new Error("Falta nombre")); }

            let estadoFinal = estadoOverride || "activo";
            if (type === "restaurante" && !estadoOverride) estadoFinal = document.getElementById("inpEstadoRest").value;

            // Datos base
            const dataBase = {
                hotel: currentHotel, type, nombre,
                tel: document.getElementById("inpTel").value,
                email: document.getElementById("inpEmail").value,
                salon: document.getElementById("inpSalon").value,
                notas: document.getElementById("inpNotas").value,
                estado: estadoFinal
            };

            // CASO 1: RESTAURANTE (Sin cambios, fecha √∫nica)
            if (type === "restaurante") {
                dataBase.hora = document.getElementById("inpHora").value;
                dataBase.paxRest = document.getElementById("inpPaxRest").value;
                dataBase.turno = document.getElementById("inpTurno").value;
                dataBase.fechaInicio = document.getElementById("inpFecha").value;
                dataBase.fechaFin = dataBase.fechaInicio;

                if (id) return db.collection("master_data").doc(id).update(dataBase).then(() => { if(!skipClose) cerrarModal(); });
                else return db.collection("master_data").add(dataBase).then((ref) => { document.getElementById("dataId").value = ref.id; if(!skipClose) cerrarModal(); });
            }

            // CASO 2: PRESUPUESTO (Rango informativo, un solo registro)
            if (type === "presupuesto") {
                dataBase.fechaInicio = document.getElementById("inpFechaDesde").value;
                dataBase.fechaFin = document.getElementById("inpFechaHasta").value;
                dataBase.total = document.getElementById("totalAmount").innerText;
                dataBase.servicios = []; // (Tu l√≥gica de extraer servicios aqu√≠...)
                document.querySelectorAll("#bodyServicios tr").forEach((tr) =>
                    dataBase.servicios.push({
                        date: tr.querySelector(".s-date").value, desc: tr.querySelector(".s-desc").value,
                        uds: tr.querySelector(".s-uds").value, price: tr.querySelector(".s-price").value, total: tr.querySelector(".s-total").value
                    })
                );
                if (!id) dataBase.ref = "PRE-" + Date.now();
                
                if (id) return db.collection("master_data").doc(id).update(dataBase).then(() => { if(!skipClose) cerrarModal(); });
                else return db.collection("master_data").add(dataBase).then((ref) => { document.getElementById("dataId").value = ref.id; if(!skipClose) cerrarModal(); });
            }

            // CASO 3: EVENTO DE SAL√ìN (Puede ser rango "Desde... Hasta...")
            if (type === "evento") {
                const fInicio = document.getElementById("inpFechaDesde").value;
                const fFin = document.getElementById("inpFechaHasta").value || fInicio;

                // Validaci√≥n de colisiones (simplificada para el ejemplo)
                // ... (Tu c√≥digo de validaci√≥n ir√≠a aqu√≠) ...

                const d1 = new Date(fInicio);
                const d2 = new Date(fFin);
                const diffDays = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));

                // Recogemos servicios
                const serviciosRaw = [];
                document.querySelectorAll("#bodyServicios tr").forEach((tr) => {
                    serviciosRaw.push({
                        date: tr.querySelector(".s-date").value, desc: tr.querySelector(".s-desc").value,
                        uds: tr.querySelector(".s-uds").value, price: tr.querySelector(".s-price").value, total: tr.querySelector(".s-total").value
                    });
                });

                // Si estamos editando (id existe) y no cambiamos fechas, update normal.
                // Si es nuevo y es rango, hacemos bucle.
                
                if (id) {
                    // EDICI√ìN SIMPLE (Asumimos que al editar no expandimos rango para simplificar, o solo editas el d√≠a actual)
                    dataBase.fechaInicio = fInicio; 
                    dataBase.fechaFin = fInicio; // Forzamos single day al editar para no romper
                    dataBase.paxA = document.getElementById("inpPaxA").value;
                    dataBase.montaje = document.getElementById("inpMontaje").value;
                    dataBase.turno = document.getElementById("inpTurnoEvento").value;
                    dataBase.servicios = serviciosRaw;
                    return db.collection("master_data").doc(id).update(dataBase).then(() => { if(!skipClose) cerrarModal(); });
                } else {
                    // NUEVO REGISTRO (Posible Bucle)
                    const promesas = [];
                    for (let i = 0; i <= diffDays; i++) {
                        const fechaActual = sumarDiasFecha(fInicio, i);
                        const evtDia = { ...dataBase }; // Copia
                        evtDia.fechaInicio = fechaActual;
                        evtDia.fechaFin = fechaActual;
                        evtDia.paxA = document.getElementById("inpPaxA").value;
                        evtDia.montaje = document.getElementById("inpMontaje").value;
                        evtDia.turno = document.getElementById("inpTurnoEvento").value;
                        
                        // Asignar servicios que coincidan con la fecha
                        evtDia.servicios = serviciosRaw.filter(s => s.date === fechaActual || !s.date);
                        
                        promesas.push(db.collection("master_data").add(evtDia));
                    }
                    return Promise.all(promesas).then(() => {
                        alert("Eventos creados correctamente (" + (diffDays+1) + " d√≠as).");
                        if(!skipClose) cerrarModal();
                    });
                }
            }

        } catch (e) { alert("Error: " + e.message); }
    }

    // 4. NUEVA FUNCI√ìN: ORDEN DE SERVICIO
    function generarOrdenServicio() {
        const fInicio = document.getElementById("fechaVista").value;
        // Calculamos +7 d√≠as para el listado
        const fFin = sumarDiasFecha(fInicio, 7);

        // Filtramos datos de la memoria (dataCache)
        // Buscamos Eventos y Restaurante activos en ese rango
        const listado = dataCache.filter(d => {
            if(d.hotel !== currentHotel) return false;
            if(d.estado === 'anulado') return false;
            if(d.type === 'presupuesto') return false; // Solo confirmados/eventos reales
            
            return d.fechaInicio >= fInicio && d.fechaInicio <= fFin;
        });

        // Ordenar por fecha y luego por hora/turno
        listado.sort((a, b) => {
            if(a.fechaInicio !== b.fechaInicio) return a.fechaInicio.localeCompare(b.fechaInicio);
            // Si es restaurante tiene hora
            const hA = a.hora || (a.turno==='manana'?'14:00':'21:00');
            const hB = b.hora || (b.turno==='manana'?'14:00':'21:00');
            return hA.localeCompare(hB);
        });

        let filas = "";
        listado.forEach(item => {
            const fecha = item.fechaInicio.split('-').reverse().join('/');
            const hora = item.hora || (item.turno === 'manana' ? '‚òÄÔ∏è Almuerzo' : (item.turno === 'tarde' ? 'üåô Cena' : 'üìÖ Todo el d√≠a'));
            const lugar = item.salon || "Restaurante";
            const pax = (item.type === 'restaurante') ? item.paxRest : (item.paxA || 0);
            
            // Detalles del servicio (men√∫, montaje...)
            let detalles = `<b>${item.nombre}</b><br>`;
            if(item.montaje) detalles += `Montaje: ${item.montaje}<br>`;
            if(item.notas) detalles += `‚ö†Ô∏è ${item.notas}<br>`;
            
            if(item.servicios && item.servicios.length > 0) {
                detalles += `<ul style="margin:4px 0 0 15px; padding:0;">`;
                item.servicios.forEach(s => {
                    detalles += `<li>${s.uds}x ${s.desc}</li>`;
                });
                detalles += `</ul>`;
            }

            filas += `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:8px;">${fecha}</td>
                    <td style="padding:8px;">${hora}</td>
                    <td style="padding:8px;">${lugar}</td>
                    <td style="padding:8px; font-weight:bold;">${pax} pax</td>
                    <td style="padding:8px;">${detalles}</td>
                </tr>
            `;
        });

        const html = `
        <html>
        <head>
            <title>Orden de Servicio - ${currentHotel}</title>
            <style>
                body { font-family: sans-serif; padding: 20px; }
                h1 { color: #263238; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
                th { background: #eceff1; padding: 10px; text-align: left; border-bottom: 2px solid #cfd8dc; }
            </style>
        </head>
        <body>
            <h1>üìã Orden de Servicio / Previsi√≥n Semanal</h1>
            <p>Hotel: <strong>${currentHotel}</strong> | Desde: ${fInicio} | Generado: ${new Date().toLocaleString()}</p>
            <table>
                <thead>
                    <tr>
                        <th width="80">Fecha</th>
                        <th width="100">Hora/Turno</th>
                        <th width="150">Espacio</th>
                        <th width="60">Pax</th>
                        <th>Evento y Servicios</th>
                    </tr>
                </thead>
                <tbody>
                    ${filas || '<tr><td colspan="5" style="padding:20px; text-align:center">No hay eventos para esta semana.</td></tr>'}
                </tbody>
            </table>
            <script>window.print();<\/script>
        </body>
        </html>
        `;

        const win = window.open("", "_blank");
        win.document.write(html);
        win.document.close();
    }

// --- FUNCI√ìN AUXILIAR SEGURA PARA FECHAS ---
    // Esta funci√≥n evita el problema de las zonas horarias fijando la hora a las 12:00
    function sumarDiasFecha(fechaStr, dias) {
        const parts = fechaStr.split('-');
        // Creamos la fecha a mediod√≠a (12:00) para evitar que cambios de hora la muevan de d√≠a
        const d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);
        d.setDate(d.getDate() + dias);
        
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function confirmarPresupuesto() {
        // 1. Validaciones b√°sicas
        if (document.getElementById("dataType").value !== "presupuesto") return;
        
        const salon = document.getElementById("inpSalon").value;
        if (!salon || salon === "Pendiente" || salon.startsWith("--")) { 
            alert("Para confirmar, por favor selecciona un Sal√≥n definitivo."); 
            return; 
        }
        
        const nombre = document.getElementById("inpNombre").value;
        if (!nombre) { alert("El nombre del evento es obligatorio."); return; }

        const fInicio = document.getElementById("inpFechaDesde").value;
        const fFin = document.getElementById("inpFechaHasta").value || fInicio;

        // Calcular cu√°ntos d√≠as hay de diferencia
        const d1 = new Date(fInicio);
        const d2 = new Date(fFin);
        const diffTime = Math.abs(d2 - d1);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        // diffDays ser√° 0 si es el mismo d√≠a, 1 si son dos d√≠as, etc.

        // 2. Primero guardamos el presupuesto original como "confirmado"
        guardarFicha("confirmado", true).then((pptoId) => {
            
            const promesas = [];

            // 3. Iteramos por cada d√≠a del rango (desde 0 hasta diffDays)
            for (let i = 0; i <= diffDays; i++) {
                
                // Generamos la fecha exacta para este d√≠a del bucle
                const fechaActual = sumarDiasFecha(fInicio, i);

                // Preparamos los datos base del evento
                const eventoData = {
                    hotel: currentHotel, 
                    type: "evento", 
                    nombre: nombre, 
                    salon: salon,
                    fechaInicio: fechaActual, // IMPORTANTE: Fecha √∫nica para este d√≠a
                    fechaFin: fechaActual,    // Empieza y acaba el mismo d√≠a
                    paxA: document.getElementById("inpPaxA").value,
                    paxN: document.getElementById("inpPaxN").value,
                    montaje: document.getElementById("inpMontaje").value,
                    notas: document.getElementById("inpNotas").value,
                    estado: "confirmado",
                    turno: "dia_completo",
                    refPresupuesto: pptoId
                };

                // 4. Filtrar servicios: Solo metemos los que coincidan con la fecha de HOY
                // O si el servicio no tiene fecha, lo metemos en el primer d√≠a por defecto.
                const serviciosDia = [];
                let totalDia = 0;

                document.querySelectorAll("#bodyServicios tr").forEach((tr) => {
                    const svcDate = tr.querySelector(".s-date").value;
                    
                    // Condici√≥n: La fecha del servicio coincide con el d√≠a que estamos creando
                    // O es el primer d√≠a (i===0) y el servicio no tiene fecha puesta
                    if (svcDate === fechaActual || (i === 0 && !svcDate)) {
                        const totalLinea = parseFloat(tr.querySelector(".s-total").value) || 0;
                        serviciosDia.push({
                            date: svcDate || fechaActual, // Aseguramos que tenga fecha
                            desc: tr.querySelector(".s-desc").value,
                            uds: tr.querySelector(".s-uds").value,
                            price: tr.querySelector(".s-price").value,
                            total: tr.querySelector(".s-total").value
                        });
                        totalDia += totalLinea;
                    }
                });

                if (serviciosDia.length > 0) {
                    eventoData.servicios = serviciosDia;
                    eventoData.total = totalDia.toFixed(2);
                } else {
                    eventoData.total = "0.00";
                }

                // A√±adimos la promesa de guardar este d√≠a a la lista
                promesas.push(db.collection("master_data").add(eventoData));
            }

            // Esperamos a que se creen TODOS los d√≠as
            return Promise.all(promesas);

        }).then(() => {
            alert(`Presupuesto confirmado correctamente.\nSe han generado ${diffDays + 1} eventos en el calendario de salones.`);
            cerrarModal();
            // Forzamos recarga visual por si acaso
            render(); 
        }).catch((e) => { 
            console.error(e); 
            alert("Ocurri√≥ un error al confirmar: " + e.message); 
        });
    }
    async function callGemini(prompt) {
        if (!apiKey) return alert("Configura la API Key de Gemini.");
        const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + apiKey;
        try {
            const r = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
            const d = await r.json();
            return d.candidates?.[0]?.content?.parts?.[0]?.text;
        } catch { return null; }
    }

    async function mejorarNotasConIA() {
        const input = document.getElementById("inpNotas");
        if (!input.value.trim()) return alert("Escribe algo primero.");
        const original = input.value;
        input.value = "Mejorando redacci√≥n...";
        const res = await callGemini("Mejora estas notas de evento: " + original);
        input.value = res || original;
    }

    async function generarMenuIA() {
        const tipo = document.getElementById("inpNombre").value || "Evento";
        const pax = document.getElementById("inpPaxA").value || "varias";
        const res = await callGemini(`Genera men√∫ corto (3 lineas texto) para evento "${tipo}" (${pax} pax).`);
        if (!res) return alert("Error IA.");
        addServiceRow({ date: document.getElementById("inpFechaDesde").value, desc: res.replace(/\n/g, " ¬∑ "), uds: document.getElementById("inpPaxA").value || 1, price: 0 });
    }

    async function redactarEmailIA() {
        const cli = document.getElementById("inpNombre").value || "cliente";
        const tot = document.getElementById("totalAmount").innerText;
        const res = await callGemini(`Email breve a ${cli} adjuntando presupuesto de ${tot}‚Ç¨.`);
        if (res) { document.getElementById("aiOutput").value = res; document.getElementById("aiResponseModal").style.display = "flex"; }
    }

    function copiarIA() {
        document.getElementById("aiOutput").select();
        document.execCommand("copy");
        document.getElementById("aiResponseModal").style.display = "none";
        alert("Copiado");
    }
</script>
</body>
</html>